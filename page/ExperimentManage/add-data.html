<!--
 * @Author: huyanhai
 * @since: 2020-02-22 13:17:08
 * @LastAuthor: huyanhai
 * @lastTime: 2020-10-22 15:34:12
 * @FilePath: /web/page/ExperimentManage/add-data.html
 * @Description: 数据采集
 -->

<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>数据采集</title>
  <link rel="stylesheet" href="../../assets/libs/layui/css/layui.css" />
  <link rel="stylesheet" href="../../assets/module/admin.css?v=314" />
  <link rel="stylesheet" href="../../assets/css/common_likui.css?v=314" />
  <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  <style>
    .search-container {
      /*height: 144px;*/
      padding: 25px 0 30px 20px;
      /*box-sizing: border-box;*/
    }

    .search-container .layui-form-radio {
      margin: 0 30px 0 0;
    }

    .project-setting-table {
      padding: 30px 20px;
    }

    .layui-table,
    .layui-table-view {
      margin: 0;
    }

    #erweicode {
      width: 150px;
      height: 150px;
      border: 1px solid #eee;
      margin: 0 auto;
      padding: 10px;
      box-sizing: border-box;
    }

    .supply-img-container {}

    .supply-img-item {
      width: 96px;
      height: 96px;
      border: 1px solid #eee;
      border-radius: 6px;
      margin-right: 20px;
      position: relative;
    }

    .supply-img-item .supply-img-close {
      width: 13px;
      height: 13px;
      cursor: pointer;
      position: absolute;
      top: -6px;
      right: -6px;
      border-radius: 50%;
      border: 1px solid rgba(255, 0, 0, 1);
      font-size: 10px;
      text-align: center;
      color: rgba(255, 0, 0, 1);
    }

    .supply-img-item img {
      width: 100%;
    }

    #contract-upload {
      width: 98px;
      height: 98px;
      border: 1px solid #eee;
      border-radius: 4px;
      text-align: center;
      font-size: 12px;
      padding: 24px 0;
      color: #999;
      cursor: pointer;
      box-sizing: border-box;
      display: inline-block;
      vertical-align: top;
    }

    .m-b-10 {
      margin-bottom: 10px;
    }

    .m-b-5 {
      margin-bottom: 5px;
    }

    .like_device {
      color: #a2a2a2;
      cursor: pointer;
      margin-right: 10px;
    }

    .like_device:hover {
      color: #26c44f;
    }

    .layui-btn-normal {
      background-color: #1e9fff !important;
      color: #ffffff !important;
    }

    .hidden {
      display: none;
    }
  </style>
</head>

<body>
  <!-- 页面加载loading -->
  <div class="page-loading">
    <div class="ball-loader"><span></span><span></span><span></span><span></span></div>
  </div>
  <form id="modelPropertyForm" lay-filter="modelPropertyForm" class="layui-form model-form" style="padding: 5px 20px">
    <!-- 正文开始 -->
    <div class="layui-fluid">
      <div class="layui-card" style="background-color: #fff">
        <div class="layui-card-body">
          <div class="layui-form-item layui-row m-b-5">
            <label><i class="layui-icon layui-icon-component"></i> 基本信息</label>
          </div>
          <div class="layui-form-item layui-row m-b-5">
            <div class="layui-col-md6">
              <label class="layui-form-label">工程名称：</label>
              <div class="layui-input-block">
                <select id="project" name="project" lay-filter="project"></select>
              </div>
            </div>
          </div>
          <div class="layui-form-item layui-row m-b-5">
            <div class="layui-col-md6">
              <label class="layui-form-label">实验编号：</label>
              <div class="layui-input-block">
                <input name="syNumber" id="syNumber" placeholder="自动/请输入" type="text" class="layui-input"
                  lay-verType="tips" />
              </div>
            </div>
            <div class="layui-col-md6">
              <label class="layui-form-label">实验类别：</label>
              <div class="layui-input-block">
                <select name="category" id="categoryName" lay-filter="categoryName" lay-verType="tips"
                  lay-verify="required" lay-search>
                  <option value="">请选择</option>
                </select>
              </div>
            </div>
          </div>
          <div class="layui-form-item layui-row m-b-5">
            <div class="layui-col-md6">
              <label class="layui-form-label">实验项目：</label>
              <div class="layui-input-block">
                <select name="project" id="projectName" lay-filter="projectName" lay-verType="tips"
                  lay-verify="required" lay-search>
                  <option value="">请选择</option>
                </select>
              </div>
            </div>
            <div class="layui-col-md6">
              <label class="layui-form-label">实验内容：</label>
              <div class="layui-input-block">
                <select name="content" id="contentName" lay-filter="contentName" lay-verType="tips"
                  lay-verify="required" lay-search>
                  <option value="">请选择</option>
                </select>
              </div>
            </div>
          </div>

          <div class="layui-form-item layui-row m-b-5">
            <div class="layui-col-md6">
              <label class="layui-form-label">样品编号：</label>
              <div class="layui-input-block">
                <input name="ypNumber" id="ypNumber" placeholder="请输入样品编号" type="text" class="layui-input"
                  lay-verType="tips" lay-verify="required" required />
              </div>
            </div>
            <div class="layui-col-md6">
              <label class="layui-form-label">样品名称：</label>
              <div class="layui-input-block">
                <input name="ypName" id="ypName" placeholder="请输入样品名称" type="text" class="layui-input"
                  lay-verType="tips" lay-verify="required" required />
              </div>
            </div>
          </div>

          <div class="layui-form-item layui-row m-b-5">
            <div class="layui-col-md6">
              <label class="layui-form-label">实验设备：</label>
              <div class="layui-input-block">
                <input name="searchSySB" id="searchSySB" placeholder="请输入实验设备" type="text" class="layui-input"
                  lay-verType="tips" />
              </div>
            </div>
            <div class="layui-col-md6">
              <!-- <button type="button" class="layui-btn layui-btn-primary" id="searchSySB">查询</button> -->
            </div>
          </div>
          <div class="layui-form-item layui-row m-b-5">
            <div class="layui-col-md6" id="uploadFj">
              <label class="layui-form-label">上传附件：</label>
              <button type="button" class="layui-btn" id="test1"><i class="layui-icon">&#xe67c;</i>上传文件</button>
              <i class="filename"></i>
              <input type="text" name="file" style="display: none" id="filed" />
            </div>
            <div class="layui-col-md6" id="downFj" style="display: none;">
              <label class="layui-form-label">下载附件：</label>
              <button type="button" class="layui-btn"><i class="layui-icon">&#xe62d;</i>下载附件</button>
            </div>
          </div>
          <!--实验设备模糊查询的结果展示区域-->
          <div class="layui-form-item layui-row m-b-5">
            <div class="layui-col-md12">
              <div class="layui-input-block" id="deviceList"></div>
            </div>
          </div>

          <hr />
          <div class="layui-form-item text-center p-30">
            <button class="layui-btn layui-btn-primary" id="back" lay-submit>返回</button>
            <!-- <button class="layui-btn layui-btn-normal" lay-filter="previewData" lay-submit>预览</button> -->
            <button class="layui-btn" type="button" ew-event="closePageDialog" id="finishSy">保存</button>
          </div>

          <!-- <div class="project-setting-table bg-white mt-20">
                <table class="layui-table" id="tableProject" lay-filter="tableProject" style="margin: 0;"></table>
            </div> -->
        </div>
      </div>
    </div>
  </form>
  <!-- js部分 -->
  <script type="text/javascript" src="../../assets/libs/layui/layui.js"></script>
  <script type="text/javascript" src="../../assets/js/common.js?v=314"></script>
  <script type="text/javascript" src="../../assets/libs/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="../../assets/js/jquery.qrcode.min.js"></script>
  <script type="text/javascript" src="../../assets/js/server.js"></script>
  <script>
    var zdId = localStorage.getItem("station");
    var api_url = getServerUrl(zdId);
    // url = "http://test.zgdrkj.cn:8081/CjManager/"
    // api_url = "https://test.zgdrkj.cn/xinfeng";
    function getQueryVariable(variable) {
      var query = window.location.search.substring(1);
      var vars = query.split("&");
      for (var i = 0; i < vars.length; i++) {
        var pair = vars[i].split("=");
        if (pair[0] == variable) {
          return pair[1];
        }
      }
      return false;
    }
    layui.use(["layer", "form", "table", "util", "laydate", "admin", "element", "upload"], function () {
      var $ = layui.jquery;
      var layer = layui.layer;
      var form = layui.form;
      var table = layui.table;
      var laydate = layui.laydate;
      var upload = layui.upload;
      var admin = layui.admin;
      var element = layui.element;
      var editSyNumber = getQueryVariable("editSyNumber");
      var syId = null;
      var fileName;
      upload.render({
        elem: "#test1",
        accept: "file",
        method: "POST",
        // exts: "xlsx|xls",
        url: api_url + "/api/data/fileUpload",
        choose: function (obj) {
          //将每次选择的文件追加到文件队列
          // var files = obj.pushFile();
          obj.preview(function (index, file, result) {
            console.log(file.name); //得到文件对象
            $(".filename").html(file.name);
          });
        },
        done: function (res, index, upload) {
          //假设code=0代表上传成功
          if (res.code == 200) {
            layer.msg("上传成功");
            $("#filed").val(res.data);
          } else {
            layer.msg("上传失败");
          }
        },
      });


      // 获取实验类别下啦选项
      function categoryList() {
        var url = api_url + "/api/data/getCategoryList";
        ajaxReq(url, "get", {}, categoryListCallback);
      }


      //选择实验类别 获取实验项目
      form.on("select(categoryName)", function (data) {
        getProject(data.value);
        form.render("select");
      });

      // 获取实验项目下啦
      function getProject(category) {
        var url = api_url + "/api/data/getProject";
        var data = {
          category: category,
        };
        ajaxReq(url, "get", data, getProjectCallback);
      }

      //实验项目 下啦选项
      function getProjectCallback(res) {
        var data = res.data;
        var format_data = Array();
        for (var i in data) {
          if (i.indexOf("projectName") !== -1 && $.trim(data[i]) !== "") {
            format_data.push({
              projectName: data[i],
            });
          }
        }
        selectHtml(format_data, "#projectName", "projectName", "projectName");
      }


      // 实验项目 获取实验内容
      form.on("select(projectName)", function (data) {
        console.log("change")
        var categray = $("#categoryName").val();
        getContent(data.value, categray);
        form.render("select");
      });



      //选择实现内容 获取实验内容的实验参数
      form.on("select(contentName)", function (data) {
        console.log(data)
        getData(data.value);
        form.render("select");
      });


      //实验内容
      function getContent(project, category) {
        var url = api_url + "/api/data/getContent";
        var data = {
          project: project,
          category: category,
        };
        ajaxReq(url, "get", data, getContentCallback);
      }

      //实验内容 回调函数
      function getContentCallback(res) {
        var data = res.data;
        var format_data = Array();
        for (var i in data) {
          if (i.indexOf("content") !== -1 && $.trim(data[i]) !== "") {
            format_data.push({
              contentName: data[i],
            });
          }
        }
        selectHtml(format_data, "#contentName", "contentName", "contentName");
      }

      // 获取项目选择
      function projData(lurl, dom) {
        $.ajax({
          url: lurl,
          type: "get",
          data: { "idzhandian": localStorage.getItem("station_id") },
          success: function (res) {
            var data = res;
            var html = '<option value="">请选择</option>';
            data.forEach(function (item) {
              html += '<option value="' + item.project_no + '">' + item.project_name + "</option>";
            });
            $(dom).html(html);
            layui.form.render("select");
          },
        });
      }

      projData(url + "production/getProjectList", "#project");

      categoryList(); // 获取实验类别下啦数据

      // 表单数据回填
      if (editSyNumber) {
        $("#downFj").show()
        getEditData("/api/data/getSyDetails", function (data) {
          fileName = data.file;
          $("#syNumber").val(data.syNumber)
          $("#categoryName").val(data.category)
          $("#project").val(data.project)
          $("#searchSySB").val(data.sySB)
          $("#ypName").val(data.ypName)
          $("#ypNumber").val(data.ypNumber)
          $("#projectName").val(data.projectName)
          $("#filed").val(data.file)
          $(".filename").html(data.file);
          syId = data.id;
          if (data["project"]) {
            var select = "dd[lay-value=" + data["project"] + "]";
            $("#project").siblings("div.layui-form-select").find("dl").find(select).click();
          }
          if (data["category"]) {
            var select = "dd[lay-value=" + data["category"] + "]";
            $("#categoryName").siblings("div.layui-form-select").find("dl").find(select).click();
            if (data["projectName"]) {
              setTimeout(function () {
                var select = "dd[lay-value=" + data["projectName"] + "]";
                $("#projectName").siblings("div.layui-form-select").find("dl").find(select).click(); //选择当前的实验项目
                setTimeout(function () {
                  if (data["content"]) {
                    var select = "dd[lay-value=" + data["content"] + "]";
                    $("#contentName").siblings("div.layui-form-select").find("dl").find(select).click(); //选择当前的实验内容
                  }
                }, 1000)
              }, 1000)
            }
          }


        })
      } else {
        $("#downFj").hide()
      }

      // 获取编辑数据Api
      function getEditData(lurl, cb) {
        $.ajax({
          url: api_url + lurl,
          type: "get",
          data: { "idzhandian": localStorage.getItem("station_id"), syNumber: editSyNumber },
          success: function (res) {
            if (res.code === 200) {
              cb && cb(res.data)
            }
          },
        });
      }

      //实验类别 回调函数
      function categoryListCallback(res) {
        selectHtml(res.data, "#categoryName", "categoryName", "categoryName");
      }

      //获取实验内容的实验参数
      function getData(contentName) {
        var url = api_url + "/api/data/getData";
        // var url = 'http://47.114.106.162:8080/cangzhou/api/data/getData';
        var data = {
          data: contentName,
        };
        console.log(contentName)
        ajaxReq(url, "get", data, getDataCallback);
        return false;
      }

      //实验内容的实验参数 回调函数
      function getDataCallback(res) {
        var data = res.data;
        var format_data = Array();
        for (var i in data) {
          if (i !== "id" && i !== "content" && $.trim(data[i]) !== "") {
            format_data.push({
              key_desc: data[i],
              key_name: i,
              value: "",
            }); //参数键值、参数值
          }
        }
      }

      //请求数据
      function ajaxReq(url, type, data = {}, callback, headers = {}) {
        $.ajax({
          headers: headers,
          url: url,
          type: type,
          data: data,
          success: function (res) {
            callback(res);
          },
        });
      }

      //渲染 下拉选择框
      function selectHtml(data, select_obj, option_val, option_name) {
        var html = '<option value="">请选择</option>';
        if ($.trim(data) !== "") {
          for (var i in data) {
            html += '<option value="' + data[i][option_val] + '">' + data[i][option_name] + "</option>";
          }
        }
        $(select_obj).html(html);
        layui.form.render("select");
      }

      // 下载附件
      $("body").on("click", "#downFj", function () {
        window.location.href = `${api_url}/api/data/downloadBgFile/${fileName}`;
      })

      //结束实验
      $("body").on("click", "#finishSy", function () {
        var syNumber = $("#syNumber").val();
        if ($.trim(syNumber) === "") {
          $("#syNumber").focus();
          layer.msg("请先输入有效的实验编号", {
            icon: 2,
          });
          return false;
        }
        var data = {
          syNumber: syNumber,
          category: $("#categoryName").val(),
          content: $("#contentName").val(),
          project: $("#project").val(),
          sysb: $("#searchSySB").val(),
          file: $("#filed").val(),
          ypName: $("#ypName").val(),
          ypNumber: $("#ypNumber").val(),
          projectName: $("#projectName").val(),
          id: syId || null
        };
        finishSy(data, finishSyCallback);
      });

      //结束实验数据的录入
      function finishSy(data, callback) {
        console.log(data);

        var url = api_url + "/api/data/finishSy";
        data = JSON.stringify(data);
        var headers = {
          "Content-Type": "application/json; charset=utf-8",
        };
        ajaxReq(url, "post", data, callback, headers);
      }

      //结束实验数据的录入的回调函数
      function finishSyCallback(res) {
        layer.closeAll("loading");
        if (res.code === 200) {
          layer.msg("实验结束成功", {
            icon: 1,
          });
          $("#uploadFj").show()
          $("#downFj").hide()
          window.location.href = "./data-collection-new.html";
        } else {
          layer.msg(res.msg, {
            icon: 2,
          });
        }
      }

      // 返回上一页
      $("body").on("click", "#back", function () {
        window.location.href = "./data-collection-new.html";
      })
    });
  </script>
</body>

</html>