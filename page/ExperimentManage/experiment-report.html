<!--
 * @Author: huyanhai
 * @since: 2020-02-22 13:17:08
 * @LastAuthor: huyanhai
 * @lastTime: 2020-09-15 17:36:25
 * @FilePath: /web/page/ExperimentManage/experiment-report.html
 * @Description: 实验报告
 -->

<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>实验报告</title>
  <link rel="stylesheet" href="../../assets/libs/layui/css/layui.css" />
  <link rel="stylesheet" href="../../assets/module/admin.css?v=314" />
  <link rel="stylesheet" href="../../assets/css/common_likui.css?v=314" />
  <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  <style>
    .search-container {
      box-sizing: border-box;
    }

    .search-container .layui-form-radio {
      margin: 0 30px 0 0;
    }

    .project-setting-table {
      padding: 30px 20px;
    }

    .layui-table,
    .layui-table-view {
      margin: 0;
    }

    .layui-btn.layui-btn-green {
      border-radius: 15px;
      height: 30px;
      line-height: 30px;
      color: #fff;
      padding: 0 25px;
    }

    #erweicode {
      width: 150px;
      height: 150px;
      border: 1px solid #eee;
      margin: 0 auto;
      padding: 10px;
      box-sizing: border-box;
    }

    .supply-img-container {}

    .supply-img-item {
      width: 96px;
      height: 96px;
      border: 1px solid #eee;
      border-radius: 6px;
      margin-right: 20px;
      position: relative;
    }

    .supply-img-item .supply-img-close {
      width: 13px;
      height: 13px;
      cursor: pointer;
      position: absolute;
      top: -6px;
      right: -6px;
      border-radius: 50%;
      border: 1px solid rgba(255, 0, 0, 1);
      font-size: 10px;
      text-align: center;
      color: rgba(255, 0, 0, 1);
    }

    .supply-img-item img {
      width: 100%;
    }

    #contract-upload {
      width: 98px;
      height: 98px;
      border: 1px solid #eee;
      border-radius: 4px;
      text-align: center;
      font-size: 12px;
      padding: 24px 0;
      color: #999;
      cursor: pointer;
      box-sizing: border-box;
      display: inline-block;
      vertical-align: top;
    }

    .btn-look {
      color: rgb(42, 197, 82) !important;
    }

    .btn-look .btn-icon {
      background: url(../../assets/images/look2.png) no-repeat center;
      background-size: 100%;
    }

    .layui-inline {
      margin-top: 20px;
    }
  </style>
</head>

<body>
  <!-- 页面加载loading -->
  <div class="page-loading">
    <div class="ball-loader"><span></span><span></span><span></span><span></span></div>
  </div>

  <!-- 正文开始 -->
  <div class="layui-fluid">
    <div class="layui-card" style="background-color: initial">
      <div class="layui-card-body">
        <div class="layui-form toolbar">
          <div class="layui-form-item">
            <div class="search-container bg-white">
              <div class="clear">
                <div class="layui-inline">
                  <label class="layui-form-label w-auto">取样日期：</label>
                  <div class="layui-input-inline" style="width: 140px">
                    <input type="text" name="taskStartTime" class="layui-input" id="test-laydate-start"
                      placeholder="开始日期" lay-key="1" />
                  </div>
                  <div class="layui-form-mid">-</div>
                  <div class="layui-input-inline" style="width: 140px">
                    <input type="text" name="taskEndTime" class="layui-input" id="test-laydate-end" placeholder="结束日期"
                      lay-key="2" />
                  </div>
                </div>

                <div class="layui-inline">
                  <label class="layui-form-label w-auto">报告目的：</label>
                  <div class="layui-input-inline" style="width: 140px">
                    <select id="reportGoal" name="type" lay-filter="type" lay-verType="tips" lay-verify="required">
                      <option value="">请选择</option>
                      <option value="日常试验">日常试验</option>
                      <option value="原材抽检">原材抽检</option>
                      <option value="生产抽检">生产抽检</option>
                    </select>
                  </div>
                </div>
                <div class="layui-inline">
                  <label class="layui-form-label w-auto">检验人员：</label>
                  <div class="layui-input-inline" style="width: 140px">
                    <select id="jyName" name="type" lay-filter="type" lay-verType="tips" lay-verify="required"></select>
                  </div>
                </div>
                <div class="layui-inline">
                  <label class="layui-form-label w-auto">报告名称：</label>
                  <div class="layui-input-inline" style="width: 140px">
                    <select name="status" id="reportName">
                      <option value="">请选择</option>
                      <option value="沥青混凝土用粗集料试验报告">沥青混凝土用粗集料试验报告</option>
                      <option value="沥青混凝土用细集料试验报告">沥青混凝土用细集料试验报告</option>
                      <option value="沥青混凝土用矿粉试验报告">沥青混凝土用矿粉试验报告</option>
                      <option value="沥青混合料稳定度试验报告">沥青混合料稳定度试验报告</option>
                    </select>
                  </div>
                </div>
                <div class="layui-inline">
                  <label class="layui-form-label w-auto">报告状态：</label>
                  <div class="layui-input-inline" style="width: 140px">
                    <select name="status" id="reportState">
                      <option value="">请选择</option>
                      <option value="0">审核中</option>
                      <option value="1">已完成</option>
                      <option value="2">已审核</option>
                    </select>
                  </div>
                </div>
                <div class="layui-inline">
                  <label class="layui-form-label w-auto">关键字：</label>
                  <div class="layui-input-inline" style="width: 140px">
                    <input id="param" type="text" name="gl_person" class="layui-input" placeholder="请输入关键字" />
                  </div>
                </div>
              </div>
              <div class="mt-20" style="text-align: center; padding-bottom: 20px">
                <button id="btnSearch" class="layui-btn layui-btn-green3">查询</button>
                <a id="btnAddProperty" class="layui-btn layui-btn-red"
                  onclick="window.location.href = './report-add.html'">新增</a>
              </div>
            </div>
          </div>
        </div>
        <div class="project-setting-table bg-white mt-20">
          <table class="layui-table" id="tableProject" lay-filter="tableProject" style="margin: 0"></table>
        </div>
      </div>
    </div>
  </div>

  <!-- 表格操作列 -->
  <script type="text/html" id="tableBarProperty">
      <a class="layui-btn layui-btn-xs table-btn btn-look" lay-event="see"><span class="btn-icon"></span>查看</a>
      <a class="layui-btn layui-btn-xs table-btn btn-edit" lay-event="edit"><span class="btn-icon"></span>修改</a>
      <a class="layui-btn layui-btn-xs table-btn btn-del" lay-event="del"><span class="btn-icon"></span>删除</a>
    </script>

  <!-- 弹窗-->
  <script type="text/html" id="modelProperty">
      <form id="modelPropertyForm" lay-filter="modelPropertyForm" class="layui-form model-form">
        <div class="layui-form-item">
          <label class="layui-form-label">样品名称</label>
          <div class="layui-input-block">
            <select id="type" name="type" lay-filter="type" lay-verType="tips" lay-verify="required" placeholder="请选择样品名称"></select>
          </div>
        </div>
        <div class="layui-form-item">
          <label class="layui-form-label">样品数量</label>
          <div class="layui-input-block">
            <input type="text" name="username" lay-verify="title" autocomplete="off" placeholder="请输入样品数量" class="layui-input" />
          </div>
        </div>
        <div class="layui-form-item">
          <label class="layui-form-label">委托单位</label>
          <div class="layui-input-block">
            <input type="text" name="username" lay-verify="title" autocomplete="off" placeholder="请输入委托单位" class="layui-input" />
          </div>
        </div>
        <div class="layui-form-item">
          <label class="layui-form-label">项目名称</label>
          <div class="layui-input-block">
            <input type="text" name="username" lay-verify="title" autocomplete="off" placeholder="请输入项目名称" class="layui-input" />
          </div>
        </div>
        <div class="layui-form-item text-center p-30">
          <button class="layui-btn layui-btn-primary" lay-filter="modelSubmitAddCustomer" lay-submit>保存</button>
          <button class="layui-btn" type="button" ew-event="closePageDialog">取消</button>
        </div>
      </form>
    </script>

  <!-- 状态 -->
  <script type="text/html" id="manageState">
      {{# if(d.reportState === 0) { }} 审核中 {{# } else if(d.reportState === 1) { }} 已完成 {{# } else if(d.reportState === 2) { }} 已审核 {{# } }}
    </script>
  <!-- js部分 -->
  <script type="text/javascript" src="../../assets/libs/layui/layui.js"></script>
  <script type="text/javascript" src="../../assets/js/common.js?v=314"></script>
  <script type="text/javascript" src="../../assets/libs/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="../../assets/js/server.js"></script>
  <script>
    var zdId = localStorage.getItem("station");
    var api_url = getServerUrl(zdId);
    layui.use(["layer", "form", "table", "util", "laydate", "admin", "element", "upload"], function () {
      var $ = layui.jquery;
      var layer = layui.layer;
      var form = layui.form;
      var table = layui.table;
      var util = layui.util;
      var laydate = layui.laydate;
      var admin = layui.admin;
      var upload = layui.upload;
      var element = layui.element;
      var insTb = table.render({
        elem: "#tableProject",
        url: api_url + `/api/data/getReportList`,
        page: true,
        cellMinWidth: 100,
        cols: [
          [
            {
              field: "reportNumber",
              align: "center",
              title: "报告编号",
            },
            {
              field: "reportName",
              align: "center",
              title: "报告名称",
            },
            {
              field: "reportGoal",
              align: "center",
              title: "报告目的",
            },
            {
              field: "wtUnit",
              align: "center",
              title: "委托单位",
            },
            {
              field: "projectName",
              align: "center",
              title: "工程名称",
            },
            {
              field: "syTime",
              align: "center",
              title: "试验日期",
            },
            {
              field: "syResult",
              align: "center",
              title: "试验结果",
            },
            {
              field: "jyName",
              align: "center",
              title: "检验人员",
            },
            {
              field: "reportState",
              align: "center",
              title: "报告状态",
              templet: "#manageState",
            },
            {
              align: "center",
              toolbar: "#tableBarProperty",
              title: "操作",
              minWidth: 200,
              fixed: "right",
            },
          ],
        ],
        request: {
          pageName: "page", //页码的参数名称，默认：page
          limitName: "pageSize", //每页数据量的参数名，默认：limit
        },
        where: {
          startTime: $("#test-laydate-start").val(),
          endTime: $("#test-laydate-end").val(),
          reportGoal: $("#reportGoal").val(),
          jyName: $("#jyName").val(),
          reportName: $("#reportName").val(),
          reportState: $("#reportState").val(),
          param: $("#param").val(),
        },
        parseData: function (res) {
          var data = res;
          data["code"] = data["code"] === 200 ? 0 : null;
          return {
            data: data.data.data,
            code: data.code,
            count: data.data.count,
          };
        },
        done: function (res, curr, count) {
          $("#total").html(count);
        },
      });
      //查询
      $("#btnSearch").on("click", (e) => {
        insTb.reload({
          where: {
            startTime: $("#test-laydate-start").val(),
            endTime: $("#test-laydate-end").val(),
            reportGoal: $("#reportGoal").val(),
            jyName: $("#jyName").val(),
            reportName: $("#reportName").val(),
            reportState: $("#reportState").val(),
            param: $("#param").val(),
          },
          page: {
            curr: 1,
          },
        });
      });
      bindtype();
      // 获取下拉框数据,并渲染
      function bindtype(lurl, dom, name, value, data) {
        if (!url || !dom) return false;
        $.ajax({
          url: url + lurl,
          type: "get",
          data: data,
          success: function (res) {
            var data = res.list;
            var html = '<option value="">请选择</option>';
            $.each(data, function (item) { });
            data.forEach(function (item) {
              html += '<option value="' + item[value] + '">' + item[name] + "</option>";
            });
            $(dom).html(html);
            layui.form.render("select");
          },
        });
      }

      bindtype("/sysuser/getUserList", "#jyName", "userName", "userName", {
        currentIndex: 1,
        pageSize: 9999,
      });

      //日期
      laydate.render({
        elem: "#test-laydate-start",
        trigger: "click",
        format: "yyyy-MM-dd",
        done: function (value, date, endDate) {
          var startDate = new Date(value).getTime();
          var endTime = new Date($("#test-laydate-end").val()).getTime();
          if (endTime < startDate) {
            layer.msg("开始时间不能大于结束时间");
            $("#test-laydate-start").val($("#test-laydate-end").val());
          }
        },
      });
      laydate.render({
        elem: "#test-laydate-end",
        trigger: "click",
        format: "yyyy-MM-dd",
        done: function (value, date, endDate) {
          var startDate = new Date($("#test-laydate-start").val()).getTime();
          var endTime = new Date(value).getTime();
          if (endTime < startDate) {
            layer.msg("结束时间不能小于开始时间");
            $("#test-laydate-end").val($("#test-laydate-start").val());
          }
        },
      });
      //客户操作
      table.on("tool(tableProject)", function (obj) {
        var data = obj.data;
        var layEvent = obj.event;
        if (layEvent === "del") {
          layer.confirm(
            "确定要删除“" + data.reportName + "”吗？",
            {
              skin: "layui-layer-admin",
              shade: 0.1,
            },
            function (i) {
              layer.close(i);
              layer.load(2);
              $.post({
                url: api_url + `/api/data/delReport`,
                data: JSON.stringify({
                  reportNumber: data.reportNumber,
                }),
                contentType: "application/json;utf-8",
                success: function (res) {
                  layer.closeAll("loading");
                  if (res.code == 200) {
                    layer.msg(res.msg, {
                      icon: 1,
                    });
                    insTb.reload();
                  } else {
                    layer.msg(res.msg, {
                      icon: 2,
                    });
                  }
                },
              });
            }
          );
        } else if (layEvent === "see") {
          window.location.href = `${api_url}/api/data/downloadBgFile/${data.reportNumber}`;
        } else if (layEvent === "edit") {
          window.location.href = `./report-add.html?pageType=edit&reportNumber=${data.reportNumber}`;
        }
      });

      function bindImgList(mUser) {
        $.ajax({
          url: url + "/shebei/getassetsDetails",
          type: "get",
          async: false,
          data: {
            id: mUser.id,
          },
          success: function (res) {
            if (res.code == 0) {
              var html = "";
              $.each(res.data.img_list, function () {
                html +=
                  '<li img_url="' +
                  this.img_url +
                  '" class="pull-left supply-img-item"><img src="' +
                  imgUrl +
                  this.img_url +
                  '"><i   class="supply-img-close  layui-icon" onclick="getdeleteImg(this)">&#x1006;</i></li>';
              });
              $("#img_list").html(html);
            }
          },
        });
      }

      // 显示表单弹窗
      function showEditModel(mUser) {
        admin.open({
          type: 1,
          area: "600px",
          title: mUser ? mUser : "弹窗",
          content: $("#modelProperty").html(),
          success: function (layero, dIndex) {
            $("[name='status']").val(mUser.status);
            //layui.form.render("select");
            form.val("modelPropertyForm", mUser);
            //执行一个laydate实例
            laydate.render({
              elem: "#cg_date", //指定元素
            });
            laydate.render({
              elem: "#rk_date", //指定元素
            });
            if (mUser != "添加") {
              bindImgList(mUser);
            }
            // 生成二维码
            $("#erweicode").qrcode({
              width: 130,
              height: 130,
              text: "id=" + mUser.id,
            });
            // 上传头像
            var insUpload = upload.render({
              elem: "#contract-upload", //绑定元素
              url: url + "/upload/file", //上传接口
              done: function (res) {
                //上传完毕回调
                headFile = res.data.filePath;
                var append =
                  '<li img_url="' +
                  headFile +
                  '" class="pull-left supply-img-item"><img src="' +
                  imgUrl +
                  headFile +
                  '"><i   class="supply-img-close  layui-icon" onclick="getdeleteImg(this)">&#x1006;</i></li>';
                $("#img_list").append(append);
                //alert("图片上传成功，路劲为：" + headFile);
              },
              error: function () {
                //请求异常回调
              },
            });

            // 表单提交事件
            form.on("submit(modelSubmitAddCustomer)", function (data) {
              layer.load(2);
              var parm = data.field;
              var img_list = new Array();
              $.each($("#img_list li"), function (i, item) {
                var model = {
                  id: null,
                  assets_code: "",
                  img_url: $(item).attr("img_url"),
                };
                img_list.push(model);
              });
              var json = JSON.stringify({
                ...data.field,
                create_user: localStorage.getItem("userid"),
                zhandian_id: localStorage.getItem("station_id"),
                status: $("#a_status").val(),
                id: mUser.id,
                code: mUser.code,
                img_list: img_list,
              });
              $.ajax({
                url: url + "/shebei/addassets",
                type: "post",
                async: false,
                contentType: "application/json;utf-8",
                dataType: "json",
                data: json,
                success: function (res) {
                  layer.closeAll("loading");
                  if (res.code == 0) {
                    layer.msg(res.msg, {
                      icon: 1,
                    });
                    insTb.reload();
                  } else {
                    layer.msg(res.msg, {
                      icon: 2,
                    });
                  }
                },
              });
            });
          },
        });
      }
      // 新增项目
      $("#btnAddProperty").on("click", (e) => {
        showEditModel("样品标识新增");
      });

      //一些事件监听
      element.on("tab(projectSetting)", function (data) {
        console.log(data);
      });
    });
  </script>
</body>

</html>