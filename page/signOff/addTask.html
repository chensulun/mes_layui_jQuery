<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>新增项目</title>
    <link rel="stylesheet" href="../../assets/libs/layui/css/layui.css"/>
    <link rel="stylesheet" href="../../assets/module/admin.css?v=314"/>
    <link rel="stylesheet" href="../../assets/css/common_likui.css?v=314"/>
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <style>
        .layui-form-label {
            min-width: 130px;
            box-sizing: border-box;
            padding-left: 0;
        }
        .layui-form-item .layui-input-inline {
            width: calc(100% - 140px);
            margin-right: 0;
        }
        .task-container {
            padding: 30px 30px 0;
            box-shadow:0px 1px 11px 0px rgba(239,244,255,1);
            border-radius:2px;
        }
        .task-tip {
            color: rgba(107, 107, 107, 1);
            line-height: 30px;
            font-size: 12px;
        }
        .task-title {
            border-left: 4px solid rgba(26, 185, 155, 1);
            padding-left: 8px;
            font-size: 14px;
            line-height: 20px;
            color: rgba(51, 51, 51, 1);
            position: relative;
            font-weight: bold;
        }
        .task-title:after {
            content: '';
            width: calc(100% - 70px);
            border-top: 1px dashed rgba(208, 211, 221, 1);
            position: absolute;
            right: 0;
            top: 9px;
        }
        .task-content {
            padding: 20px 10px;
        }
		.notclickn{
			pointer-events: none;
		}
    </style>

</head>
<body>

<!-- 页面加载loading -->
<div class="page-loading">
    <div class="ball-loader">
        <span></span><span></span><span></span><span></span>
    </div>
</div>

<!-- 正文开始 -->
<div class="layui-fluid" id="taskcontent">
    <div class="task-tip mt-10"><span class="text-red">*</span>红色为必填项</div>
    <div class="task-container bg-white layui-form">
        <div class="task-item">
            <div class="task-title">任务信息</div>
            <div class="task-content layui-form-item">
                <div class="layui-row">
                    <div class="layui-col-md4 p-10">
                        <label class="layui-form-label w-auto">任务单编号</label>
                        <div class="layui-input-inline" style="margin-bottom: 0px;">
                            <input name="task_no"  readonly="readonly" class="layui-input" type="text" id="task_no" placeholder="请输入任务单编号"/>
                        </div>
                    </div>
                    <div class="layui-col-md4 p-10" readonly>
                        <label class="layui-form-label w-auto">审核状态</label>
						<input type="hidden" name="zzshzt" id="zzshzt" value="0" />
                        <div class="layui-input-inline notclickn" style="margin-bottom: 0px;">
                            <input type="radio" name="checkauditstatus" value="0" title="未审批" checked>
                            <input type="radio" name="checkauditstatus" value="1" title="已审批" >
                        </div>
                    </div>
                    <div class="layui-col-md4 p-10">
                        <label class="layui-form-label w-auto">审核人</label>
                        <div class="layui-input-inline" style="margin-bottom: 0px;">
                            <input name="audit_name" readonly="readonly" class="layui-input" type="text" id="audit_name" placeholder="请输入审核人"/>
                        </div>
                    </div>
                    <div class="layui-col-md4 p-10">
                        <label class="layui-form-label w-auto">是否开盘</label>
						<input type="hidden" name="is_open" id="is_open" value="0" />
                        <div class="layui-input-inline" style="margin-bottom: 0px;">
                            <input type="radio" name="isopentatus" value="1" title="是"  lay-filter="isopentatus">
                            <input type="radio" name="isopentatus" value="0" title="否" checked lay-filter="isopentatus">
                        </div>
                    </div>
                    <div class="layui-col-md4 p-10" readonly>
                        <label class="layui-form-label w-auto" style="min-width: 110px;">任务单状态</label>
                        <input type="hidden" name="task_status" id="task_status" value="2"/>
						<div class="layui-input-inline notclickn" style="margin-bottom: 0px;width: calc(100% - 120px);">
                            <input type="radio" name="checktaskstatus" value="2" title="待供" checked>
                            <input type="radio" name="checktaskstatus" value="1" title="正供">
                            <input type="radio" name="checktaskstatus" value="3" title="供毕" >
                        </div>
                    </div>
                    <div class="layui-col-md4 p-10">
                        <label class="layui-form-label w-auto"><span style="color: red;">*</span>计划量</label>
                        <div class="layui-input-inline" style="margin-bottom: 0px;">
                            <input name="plan_amount" lay-verify="required" class="layui-input" type="number" placeholder="请输入计划量"/>
                        </div>
                    </div>
                    <div class="layui-col-md4 p-10">
                        <label class="layui-form-label w-auto">追加量</label>
                        <div class="layui-input-inline" style="margin-bottom: 0px;">
                            <input name="append_amount" class="layui-input" type="number" placeholder="请输入追加量"/>
                        </div>
                    </div>
                    <div class="layui-col-md4 p-10">
                        <label class="layui-form-label w-auto">合计量</label>
                        <div class="layui-input-inline" style="margin-bottom: 0px;">
                            <input name="total_amount" class="layui-input" type="number" placeholder="请输入合计量"/>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="task-item">
            <div class="task-title">基本信息</div>
            <div class="task-content layui-form-item">
                <div class="layui-row">
                    <div class="layui-col-md4 p-10">
                        <label class="layui-form-label w-auto"><span style="color: red;">*</span>项目编号</label>
                        <div class="layui-input-inline mr0" style="margin-bottom: 0px;">
							<select name="project_no" lay-verify="required" lay-filter="xmnoList" id="xmnoList" lay-verType="tips" >
							    <option value="">请选择</option>
							    <option value="1">管理员</option>
							    <option value="2">普通用户</option>
							    <option value="3">游客</option>
							</select>
                        </div>
                    </div>
                    <div class="layui-col-md4 p-10">
						<input type="hidden" name="project_id" id="project_id" />
						<input type="hidden" name="sgdw" id="sgdw" />
                        <label class="layui-form-label w-auto"><span style="color: red;">*</span>客户名称</label>
                        <div class="layui-input-inline" style="margin-bottom: 0px;">
                            <input name="custom_name" lay-verify="required" readonly="readonly" class="layui-input" type="text" id="custom_name" placeholder="请输入客户名称"/>
                        </div>
                    </div>

                    <div class="layui-col-md4 p-10">
                        <label class="layui-form-label w-auto"><span style="color: red;">*</span>工程名称</label>
                        <div class="layui-input-inline" style="margin-bottom: 0px;">
                            <input name="engineer_name" lay-verify="required"  readonly="readonly" class="layui-input" type="text" id="engineer_name" placeholder="请输入工程名称"/>
                        </div>
                    </div>
                    <div class="layui-col-md4 p-10">
                        <label class="layui-form-label w-auto"><span style="color: red;">*</span>施工部位</label>
                        <div class="layui-input-inline mr0 select-ipt" id="selectIpt" style="margin-bottom: 0px;">
							<select lay-filter="sgbwList" id="sgbwList" lay-verType="tips" >
							    <option value="">请选择</option>
							    <option value="1">管理员</option>
							    <option value="2">普通用户</option>
							    <option value="3">游客</option>
							</select>
                            <input name="site_name" id="site_name" class="layui-input" type="hidden" />
                        </div>
                    </div>
                    <div class="layui-col-md4 p-10">
                        <label class="layui-form-label w-auto"><span style="color: red;">*</span>砼类型</label>
                        <div class="layui-input-inline" style="margin-bottom: 0px;">
                          <select name="concrete_name" lay-verify="required" lay-filter="qlxList" id="qlxList" lay-verType="tips" >
                              <option value="">请选择</option>
                              <option value="1">管理员</option>
                              <option value="2">普通用户</option>
                              <option value="3">游客</option>
                          </select>
                        </div>
                    </div>
                    <div class="layui-col-md4 p-10">
                        <label class="layui-form-label w-auto"><span style="color: red;">*</span>运输方式</label>
                        <div class="layui-input-inline" style="margin-bottom: 0px;">
                            <input name="transport_way" lay-verify="required" class="layui-input" type="text" placeholder="请输入运输方式"/>
                        </div>
                    </div>
                    <div class="layui-col-md4 p-10">
                        <label class="layui-form-label w-auto">运输设备</label>
                        <div class="layui-input-inline" style="margin-bottom: 0px;">
                            <input name="transport_device" class="layui-input" type="text" placeholder="请输入运输设备"/>
                        </div>
                    </div>
                    <div class="layui-col-md4 p-10">
                        <label class="layui-form-label w-auto">出厂温度</label>
                        <div class="layui-input-inline" style="margin-bottom: 0px;">
                            <input name="temperature" class="layui-input" type="text" placeholder="请输入出厂温度"/>
                        </div>
                    </div>
                    <div class="layui-col-md4 p-10">
                        <label class="layui-form-label w-auto">运距</label>
                        <div class="layui-input-inline" style="margin-bottom: 0px;">
                            <input name="distance" class="layui-input" type="text" placeholder="请输入运距"/>
                        </div>
                    </div>
                    <div class="layui-col-md12 p-10">
                        <label class="layui-form-label w-auto">工地地址</label>
                        <div class="layui-input-inline" style="margin-bottom: 0px;">
                            <input name="factory_addr" class="layui-input" type="text" placeholder="请输入工地地址"/>
                        </div>
                    </div>
                    <div class="layui-col-md4 p-10">
                        <label class="layui-form-label w-auto">工地联系人</label>
                        <div class="layui-input-inline" style="margin-bottom: 0px;">
                            <input name="factory_link_name" class="layui-input" type="text" placeholder="请输入工地联系人"/>
                        </div>
                    </div>
                    <div class="layui-col-md4 p-10">
                        <label class="layui-form-label w-auto">联系人电话</label>
                        <div class="layui-input-inline" style="margin-bottom: 0px;">
                            <input name="factory_link_phone" class="layui-input" type="text" placeholder="请输入联系人电话"/>
                        </div>
                    </div>
                    <div class="layui-col-md4 p-10">
                        <label class="layui-form-label w-auto">业务员电话</label>
                        <div class="layui-input-inline" style="margin-bottom: 0px;">
                            <input name="salesperson_phone" class="layui-input" type="text" placeholder="请输入业务员电话"/>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="task-item">
            <div class="task-title">其他信息</div>
            <div class="task-content layui-form-item" style="margin-bottom: 0;">
                <div class="layui-row">
                    <div class="layui-col-md4 p-10">
                        <label class="layui-form-label w-auto">发车间隔时间</label>
                        <div class="layui-input-inline" style="margin-bottom: 0px;">
                            <input name="interval_start" class="layui-input" type="number" id="interval_start" placeholder="请输入发车间隔时间"/>
                        </div>
                    </div>
                    <div class="layui-col-md4 p-10">
                        <label class="layui-form-label w-auto">调度计划开盘时间</label>
                        <div class="layui-input-inline" style="margin-bottom: 0px;">
                            <input name="scheduled_open" class="layui-input" type="text" id="scheduled_open" placeholder="请输入调度计划开盘时间"/>
                        </div>
                    </div>

                    <div class="layui-col-md4 p-10">
                        <label class="layui-form-label w-auto">实际开盘时间</label>
                        <div class="layui-input-inline" style="margin-bottom: 0px;">
                            <input name="actual_open" class="layui-input" type="text"  id="actual_open"  placeholder="请输入实际开盘时间"/>
                        </div>
                    </div>
                    <div class="layui-col-md4 p-10">
                        <label class="layui-form-label w-auto">优化配比编号</label>
                        <div class="layui-input-inline" style="margin-bottom: 0px;">
                            <input name="optimized_match_no" class="layui-input" type="text" placeholder="请输入优化配比编号"/>
                        </div>
                    </div>
                    <div class="layui-col-md4 p-10">
                        <label class="layui-form-label w-auto">工地需求供应时间</label>
                        <div class="layui-input-inline" style="margin-bottom: 0px;">
                            <input name="site_supply" class="layui-input" type="text" id="site_supply" placeholder="请输入工地需求供应时间"/>
                        </div>
                    </div>
                    <div class="layui-col-md4 p-10">
                        <label class="layui-form-label w-auto">调度计划结束时间</label>
                        <div class="layui-input-inline" style="margin-bottom: 0px;">
                            <input name="schedule_end" class="layui-input" type="text" id="schedule_end"  placeholder="请输入调度计划结束时间"/>
                        </div>
                    </div>
                    <div class="layui-col-md4 p-10">
                        <label class="layui-form-label w-auto">实际结束时间</label>
                        <div class="layui-input-inline" style="margin-bottom: 0px;">
                            <input name="actual_end" class="layui-input" type="text" id="actual_end" placeholder="请输入实际结束时间"/>
                        </div>
                    </div>
                    <div class="layui-col-md4 p-10">
                        <label class="layui-form-label w-auto">上传生成线</label>
                        <div class="layui-input-inline" style="margin-bottom: 0px;">
                            <input name="generation_line" class="layui-input" type="text" placeholder="请输入上传生成线"/>
                        </div>
                    </div>
                    <div class="layui-col-md4 p-10">
                        <label class="layui-form-label w-auto">备注</label>
                        <div class="layui-input-inline" style="margin-bottom: 0px;">
                            <input name="remark" class="layui-input" type="text" placeholder="请输入备注"/>
                        </div>
                    </div>
                    <div class="layui-col-md4 p-10">
                        <label class="layui-form-label w-auto">制表人员</label>
                        <div class="layui-input-inline" style="margin-bottom: 0px;">
                            <input name="watchmaker_name" readonly="readonly" class="layui-input" type="text" placeholder="请输入制表人员"/>
                        </div>
                    </div>
                    <div class="layui-col-md4 p-10">
                        <label class="layui-form-label w-auto">制表时间</label>
                        <div class="layui-input-inline" style="margin-bottom: 0px;">
                            <input id="tabulation_time" name="tabulation_time" readonly="readonly" class="layui-input" type="text" placeholder="请输入制表时间"/>
                        </div>
                    </div>
                    <div class="layui-col-md4 p-10">
                        <label class="layui-form-label w-auto">资料情况</label>
                        <div class="layui-input-inline" style="margin-bottom: 0px;">
                            <input name="information"   class="layui-input" type="text" placeholder="请输入资料情况"/>
                        </div>
                    </div>
                </div>
            </div>
        </div>
		<input type="hidden" id="task_id" name="task_id" />
        <div id="btns" class="text-center p-30">
            <button id="sh" class="layui-btn layui-btn-yellow1" lay-filter="formEdit" lay-submit>审核</button>
            <button id="updatetask" class="layui-btn layui-btn-gray1" lay-filter="modelSubmitAddTask" lay-submit>修改</button>
            <button id="savetask" class="layui-btn layui-btn-green1" lay-filter="modelSubmitAddTask" lay-submit>保存</button>
            <button class="layui-btn layui-btn-green2"  id="closePageDialog" >返回</button>
        </div>
    </div>
</div>

<!-- js部分 -->
<script type="text/javascript" src="../../assets/libs/layui/layui.js"></script>
<script type="text/javascript" src="../../assets/js/common.js?v=314"></script>
<script type="text/javascript" src="../../assets/libs/jquery/jquery-3.2.1.min.js"></script>
<script type="text/javascript" src="../../assets/js/tongyong.js?1234"></script>
<script>
	//url="http://localhost:8080/";
    layui.use(['layer', 'form', 'table', 'util', 'admin', 'element', 'laydate'], function () {
        var $ = layui.jquery;
        var layer = layui.layer;
        var form = layui.form;
        var table = layui.table;
        var util = layui.util;
        var admin = layui.admin;
        var element = layui.element;
		var laydate = layui.laydate;
		var taskId = getQueryString('taskId');

        var type = getQueryString('type');
        if(!!type){
            $("#updatetask").hide();
            $("#savetask").hide();
        }
        form.on('radio(isopentatus)', function(data){
            // console.log(data.elem); //得到radio原始DOM对象
            $("#is_open").val(data.value); //被点击的radio的value值
        });
        form.on('radio(checktaskstatus)', function(data){
            // console.log(data.elem); //得到radio原始DOM对象
            $("#task_status").val(data.value); //被点击的radio的value值
        });
        setDateInit(laydate);
		
		//项目下拉监听事件
		form.on('select(xmnoList)', function(data){
			$("#engineer_name").val(data.elem[data.elem.selectedIndex].getAttribute("project_name"));
			$("#custom_name").val(data.elem[data.elem.selectedIndex].getAttribute("custom_name"));
			$("#project_id").val(data.value);
			$("#sgdw").val(data.elem[data.elem.selectedIndex].getAttribute("sgdw"));
			setQlxListInit(data.value);
		})

		//项目下拉监听事件
		form.on('select(sgbwList)', function(data){
			$("#site_name").val(data.value);
		})
        //一些事件监听
        element.on('tab(projectContract)', function(data){
            if (data.index === 1) {
                insReportTb('table1', list1);
                insReportTb('table4', list4);
                insReportTb('table5', list5);
            }
        });
		//debugger;
		if(!!taskId){
				$("#savetask").hide();
			$("#task_id").val(taskId);

			$.get(url+"/production/getTaskDetail",{"taskId":taskId},function(res){
				if(res.code==0){
                    if(res.data.audit_status==-1){
                        res.data.audit_status==0
                    }
					formSerialize($("#taskcontent"),res.data);
					setXmnoListInit(res.data.project_id);
					setQlxListInit(res.data.project_id,res.data.concrete_name);
					setSgbwListInit(res.data.site_name);
					$("input[name=checkauditstatus][value=0]").attr("checked", res.data.zzshzt == 0 ? true : false);
					$("input[name=checkauditstatus][value=1]").attr("checked", res.data.zzshzt == 1 ? true : false);
					$("input[name=isopentatus][value=0]").attr("checked", res.data.is_open == 0 ? true : false);
					$("input[name=isopentatus][value=1]").attr("checked", res.data.is_open == 1 ? true : false);
					$("input[name=checktaskstatus][value=1]").attr("checked", res.data.task_status == 1 ? true : false);
					$("input[name=checktaskstatus][value=2]").attr("checked", res.data.task_status == 2 ? true : false);
					$("input[name=checktaskstatus][value=3]").attr("checked", res.data.task_status == 3 ? true : false);
					form.render(); //更新全部
				}else{
					
				}
			})
		}else{
			$("#task_id").val(0);
			setXmnoListInit(0);
			setQlxListInit(0,"");
			setSgbwListInit("");
		
			$("#updatetask").hide();
		}
		//提交保存
		form.on('submit(modelSubmitAddTask)', function (data) {
		    layer.load(2);
		    $.post(url+"/production/editTask", {
		        ...data.field,
		        watchmaker_id: data.field.watchmaker_id ? data.field.watchmaker_id : localStorage.getItem("userid"),
		        watchmaker_name: data.field.watchmaker_name ? data.field.watchmaker_name : localStorage.getItem("username")
		    }, function (res) {
		        layer.closeAll('loading');
		        if (res.code == 0) {
		            // layer.close();
		            // layer.msg(res.msg, {icon: 1});
		            // insTb.reload({}, 'data');
					parent.location.reload();
					   parent.layui.admin.events.closeThisTabs()
					 
		        } else {
		            layer.msg(res.msg, {icon: 2});
		        }
		    }, 'json');
		    return false;
		});
		
		$(document).on('click','#closePageDialog',function(){
		   parent.layui.admin.events.closeThisTabs();
		});
        var isDetail = getQueryString('isDetail');
        if(isDetail){
            $('#btns').hide();
        }
        $('#sh').on('click', () => {
            layer.confirm('确定要审核通过吗？', {
                skin: 'layui-layer-admin',
                shade: .1
            }, function() {
                xmsy();
            });
        })
        function xmsy(){
            layer.load(2);
            $.post(url + '/qianhe/addShRecord', {
                shlx: 'GuanliSh',
                shr:localStorage.getItem("userid"),
                shzt:1,
                shId:taskId
            }, function(res) {
                layer.closeAll('loading');
                if (res.code == 0) {
                    layer.msg(res.msg, {
                        icon: 1
                    });
                    parent.location.reload();
                    parent.layui.admin.events.closeThisTabs()
                } else {
                    layer.msg(res.msg, {
                        icon: 2
                    });
                }
            }, 'json');
        }
	});
	//设置项目下拉
	function setXmnoListInit(projectId){
		$.ajax({
		    type: "get",
		    url: url + '/production/getProjectList',
		    success: function(res) {
		        var str = '';
		        console.log(res, 1111)
		        for (var i = 0; i < res.length; i++) {
					if(projectId==res[i].project_id){
						 str += '<option  selected="selected" value=' + res[i].project_id + ' custom_name="'+res[i].custom_name+'" project_name="'+res[i].project_name+'" sgdw="'+res[i].sgdw+'">' + res[i].project_no + ' '+res[i].project_name + '</option>'
					}else{
						 str += '<option value=' + res[i].project_id + ' custom_name="'+res[i].custom_name+'" project_name="'+res[i].project_name+'" sgdw="'+res[i].sgdw+'">' + res[i].project_no + ' '+res[i].project_name + '</option>'
					}
		           
		        }
		        str = '<option value="">请选择</option>' + str;
		        console.log(str);
		        $('#xmnoList').html(str);
		        layui.form.render("select");
		    }
		});
	}
	//获取项目的硂类型
	function setQlxListInit(projectId,qlx){
		$.ajax({
		    type: "get",
		    url: url + '/production/getProjectFx',
			data:{projectId:projectId},
		    success: function(res) {
				var str="";
		        for (var i = 0; i < res.length; i++) {
					if(qlx== res[i].qlx){
						str += '<option  selected="selected" value=' + res[i].qlx +'>' + res[i].qlx + '</option>'
					}else{
						str += '<option  value=' + res[i].qlx +'>' + res[i].qlx + '</option>'
					}
		            
		        }
		        str = '<option value="">请选择</option>' + str;
		        console.log(str);
		        $('#qlxList').html(str);
		        layui.form.render("select");
		    }
		});
	}
	//获取施工部位
	function setSgbwListInit(site_name){
		$("#site_name").val(site_name);
		$.ajax({
		    type: "get",
		    url: url + '/production/getConstructionList',
		    success: function(res) {
				var str="";
		        for (var i = 0; i < res.length; i++) {
					if(site_name==res[i].site_name){
						
						 str += '<option value=' + res[i].site_name +' selected="selected" >' + res[i].site_name + '</option>'
					}else{
						  str += '<option value=' + res[i].site_name +'>' + res[i].site_name + '</option>'
					}
		          
		        }
		        str = '<option value="">请选择</option>' + str;
		        console.log(str);
		        $('#sgbwList').html(str);
		        layui.form.render("select");
                
		    }
		});
	}
	$('#selectIpt').on('click', () => {
        $('.select-ipt input[readonly]').removeAttr("readonly");
    });
	
	
	function setDateInit(laydate){
		//调度计划开盘时间
		laydate.render({
		    elem: '#scheduled_open',
		    trigger: 'click',
		    format: 'yyyy-MM-dd',
		    done: function (value, date, endDate) {
		        var date = new Date(value).getTime();
		        console.log(date, '调度计划开盘时间')
		    }
		});
		//实际开盘时间
		laydate.render({
		    elem: '#actual_open',
		    trigger: 'click',
		    format: 'yyyy-MM-dd',
		    done: function (value, date, endDate) {
		        var date = new Date(value).getTime();
		        console.log(date, '实际开盘时间')
		    }
		});
		//工地要求供应时间
		laydate.render({
		    elem: '#site_supply',
		    trigger: 'click',
		    format: 'yyyy-MM-dd',
		    done: function (value, date, endDate) {
		        var date = new Date(value).getTime();
		        console.log(date, '工地要求供应时间')
		    }
		});
		//调度计划结束时间
		laydate.render({
		    elem: '#schedule_end',
		    trigger: 'click',
		    format: 'yyyy-MM-dd',
		    done: function (value, date, endDate) {
		        var date = new Date(value).getTime();
		        console.log(date, '调度计划结束时间')
		    }
		});
		//实际结束时间
		laydate.render({
		    elem: '#actual_end',
		    trigger: 'click',
		    format: 'yyyy-MM-dd',
		    done: function (value, date, endDate) {
		        var date = new Date(value).getTime();
		        console.log(date, '实际结束时间')
		    }
		});

	}
</script>

</body>
</html>