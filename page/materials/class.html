<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" />
		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
		<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
		<title>原材料分类设置</title>
		<link rel="stylesheet" href="../../assets/libs/layui/css/layui.css" />
		<link rel="stylesheet" href="../../assets/module/admin.css?v=314" />
		<link rel="stylesheet" href="../../assets/css/common_likui.css?v=314" />
		<!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
		<style>
			.ycl-container {
			padding: 30px 20px;
		} 
		.ycl-container .layui-tab-title {
            border: none;
        }
        .ycl-container.layui-tab-brief>.layui-tab-title li {
            font-size: 13px;
            background-color: rgba(237,238,243,1);
            color: rgba(34, 34, 34, 1);
            padding: 4px 28px;
            line-height: 30px;
            margin-right: 24px;
            border-radius: 2px;
        }
        .ycl-container.layui-tab-brief>.layui-tab-title .layui-this {
            color: #fff;
            background-color: rgba(25, 185, 155, 1);
        }
        .ycl-container.layui-tab-brief>.layui-tab-title .layui-this:after {
            content: none;
        }
        .ycl-content {
        	min-height: 500px;
        	padding-left: 340px;
        	position: relative;
        	padding-top: 30px;
        }
        .ycl-left {
        	width: 260px;
        	height: calc(100% - 30px);
        	position: absolute;
        	left: 0;
        	top: 30px;
        	overflow: auto;
        }
        .ycl-right {
        	height: 100%;
        }
        .ycl-title {
            border-left: 4px solid rgba(26, 185, 155, 1);
            padding-left: 8px;
            font-size: 14px;
            line-height: 20px;
            color: rgba(51, 51, 51, 1);
            position: relative;
            font-weight: bold;
        }
        .ycl-title:after {
            content: '';
            width: calc(100% - 70px);
            border-top: 1px dashed rgba(208, 211, 221, 1);
            position: absolute;
            right: 0;
            top: 9px;
        }
		.ycl-tree-container {
			border:1px solid rgba(230,230,230,1);
			min-height: 320px;
		}
		.ycl2-content {
			padding: 30px 0px;
			box-sizing: border-box;
		}
		.ycl2-content .layui-input-block {
			margin-left: 120px;
		}
    </style>
	</head>
	<body>

		<!-- é?μé?￠???è??loading -->
		<div class="page-loading">
			<div class="ball-loader">
				<span></span><span></span><span></span><span></span>
			</div>
		</div>

		<!-- ?-￡?–???€?§?-->
		<div class="layui-fluid">
			<div class="layui-tab layui-tab-brief ycl-container bg-white" lay-filter="projectContract">
				<ul class="layui-tab-title">
					<li class="layui-this">原材分类设置</li>
					<!-- <li>原材扣重设定</li> -->
				</ul>
				<div class="layui-tab-content clear">
					<div class="layui-tab-item layui-show">
						<div class="ycl-content">
							<div class="ycl-left">
								<div class="ycl-title mb-30">原料分类</div>
								<div class="mb-20">
									<button class="layui-btn layui-btn-green1" id="openBtn">全打开</button>
									<button class="layui-btn layui-btn-green1" id="closeBtn">全关闭</button>
								</div>
								<ul class="ycl-tree-container ztree" id="treeAuth"></ul>
							</div>
							<div class="ycl-right">
								<form id="form_data" class="layui-form" lay-filter="add">

									<div class="ycl-title mb-30">原材参数信息</div>
									<div class="layui-row">
										<div class="layui-col-md6 mb-20">
											<label class="layui-form-label w-auto">编号:</label>
											<div class="layui-input-block" style="max-width: 350px;">
												<input name="u_Code" id="u_Code" class="layui-input" type="text" placeholder="请输入编号" lay-verType="tips"
												 lay-verify="required" required />
											</div>
										</div>
										<div class="layui-col-md6 mb-20">
											<label class="layui-form-label w-auto">名称:</label>
											<div class="layui-input-block" style="max-width: 350px;">
												<input name="u_Name" id="u_Name" class="layui-input" type="text" placeholder="请输入名称" lay-verType="tips"
												 lay-verify="required" required />
											</div>
										</div>
										<div class="layui-col-md6 mb-20">
											<label class="layui-form-label w-auto">上级类别:</label>
											<div class="layui-input-block" style="max-width: 350px;">
												<!-- <input name="u_Parent" id="u_Parent" class="layui-input" type="text" placeholder="请选择上级类别" /> -->
												<select id="u_Parent" name="u_Parent" lay-verType="tips"></select>
											</div>
										</div>
									</div>
									</from>
							</div>
						</div>

					</div>
					<div class="layui-tab-item">
						<div class="ycl2-content">
							<div class="layui-row">
								<div class="layui-col-md3 mb-20">
									<label class="layui-form-label w-auto">材料名称:</label>
									<div class="layui-input-block">
										<input name="orderAmount" class="layui-input" type="text" placeholder="请输入材料名称" />
									</div>
								</div>
								<div class="layui-col-md3 mb-20">
									<label class="layui-form-label w-auto">供应商:</label>
									<div class="layui-input-block">
										<input name="orderAmount" class="layui-input" type="text" placeholder="请输入供应商" />
									</div>
								</div>
								<div class="layui-col-md3 mb-20">
									<label class="layui-form-label w-auto">扣除重量(吨):</label>
									<div class="layui-input-block">
										<input name="orderAmount" class="layui-input" type="text" placeholder="请输入扣除重量(吨)" />
									</div>
								</div>
								<div class="layui-col-md3 mb-20">
									<label class="layui-form-label w-auto">扣除比例(%):</label>
									<div class="layui-input-block">
										<input name="orderAmount" class="layui-input" type="text" placeholder="请输入扣除比例(%)" />
									</div>
								</div>
							</div>
							<table class="layui-table" id="tableYcl" lay-filter="tableYcl" style="margin: 0;"></table>
						</div>
					</div>
				</div>
				<div class="text-center pt-30">
					<button class="layui-btn layui-btn-green1" lay-filter="add">保存</button>
					<!-- <button class="layui-btn layui-btn-green1" lay-filter="update">修改</button> -->
					<!-- <button class="layui-btn layui-btn-gray1" id="btn-delete" lay-filter="delete">删除</button> -->
					<input type="button" class="layui-btn layui-btn-gray1" onclick="getDelete()" value="删除" />
					<input type="button" class="layui-btn layui-btn-green1" onclick="getload()" value="刷新">
				</div>
			</div>
		</div>

		<!-- jsé?¨??? -->
		<script type="text/javascript" src="../../assets/libs/layui/layui.js"></script>
		<script type="text/javascript" src="../../assets/js/common.js?v=314"></script>
		<script type="text/javascript" src="../../assets/libs/jquery/jquery-3.2.1.min.js"></script>
		<script>
			var node_tree;
			layui.use(['layer', 'form', 'table', 'util', 'admin', 'element', 'zTree'], function() {
				var $ = layui.jquery;
				var layer = layui.layer;
				var form = layui.form;
				var table = layui.table;
				var util = layui.util;
				var admin = layui.admin;
				var element = layui.element;

				var options = '<option value="">请选择</option>';
				var yclList = [];
				bind_yuancailiao();

				function bind_yuancailiao() {
					var html = '';
					$.ajax({
						type: "get",
						url: url + '/yuancailiao/getyuancailiaoList',
						data: {
							zdId: localStorage.getItem("station_id")
						},
						async: false,
						success: function(res) {
							//这里循环绑定原材料,下拉列表,但是要区分层级
							formateData(res.list)
							yclList.map(val => {
								options += `<option value="${val.id}">${val.u_Name}</option>`
							})
						}
					})
					$("#u_Parent").html(options);
					layui.form.render("select");
				}

				function formateData(arr, index = 0) {
					let index1 = index;
					index++;
					return arr.map(val => {
						yclList.push({
							...val,
							u_Name: formateName(index1) + val.u_Name
						})
						if (val.children.length > 0) formateData(val.children, index);
					})
				}
				// 加空格
				function formateName(index) {
					let str = '';
					for (let i = 0; i < index; i++) {
						str += '&nbsp;&nbsp;&nbsp;&nbsp;';
					}
					return str
				}
				// 画树形图
				var setting = {
					data: {
						simpleData: {
							enable: true
						}
					},
					callback: {
						onClick: chooseNode
					}
				};
				var treeNode_id;

				function chooseNode(event, treeId, treeNode) {
					treeNode_id = treeNode.id;
					node_tree = treeNode_id;
					$.ajax({
						type: "get",
						url: url + '/yuancailiao/getyuancailiao',
						async: false,
						data: {
							id: treeNode.id,
							zdId: localStorage.getItem("station_id")
						},
						success: function(res) {
							if (res.code == 0) {
								$("#u_Code").val(res.data.u_Code);
								$("#u_Name").val(res.data.u_Name);
								$("#u_Parent").val(res.data.u_Parent);
								layui.form.render("select");
							}
						}
					})
				}
				var list = bindZtree();

				function bindZtree() {
					var json_tree;
					$.ajax({
						type: "get",
						url: url + '/yuancailiao/getyuancailiaoList',
						data: {
							zdId: localStorage.getItem("station_id")
						},
						async: false,
						success: function(res) {
							if (res.code == 0) {
								json_tree = initListData(res.list);
							}
						}
					})
					return json_tree;
				}

				function initListData(arr) {
					return arr.map(val => {
						return {
							...val,
							children: val.children.length > 0 ? initListData(val.children) : null
						}
					})
				}


				// $('#btn-delete').on('click', () => {
				// 	layer.load(2);

				// });

				form.on('submit(update)', function(data) {
					layer.load(2);
					var u_Code = $("#u_Code").val();
					var u_Name = $("#u_Name").val();
					var u_Parent = $("#u_Parent").val();
					$.ajax({
						url: url + '/yuancailiao/addyuancailiao',
						type: 'post',
						async: false,
						dataType: 'json',
						data: {
							id: treeNode_id,
							isValid: 1,
							u_Name: u_Name,
							u_Code: u_Code,
							u_Parent: u_Parent,
							zdId: localStorage.getItem("station_id")
						},
						success: function(res) {
							layer.closeAll('loading');
							if (res.code == 0) {
								layer.msg(res.msg, {
									icon: 1
								});
								insTb.reload();
							} else {
								layer.msg(res.msg, {
									icon: 2
								});
							}
						}
					});

				});
				form.on('submit(add)', function(data) {
					layer.load(2);
					if (treeNode_id == "undefined") {
						treeNode_id = null;
					}
					var u_Code = $("#u_Code").val();
					var u_Name = $("#u_Name").val();
					var u_Parent = $("#u_Parent").val();
					if (u_Parent == 'null') {
						u_Parent = null;
					}
					$.ajax({
						url: url + '/yuancailiao/addyuancailiao',
						type: 'post',
						async: false,
						dataType: 'json',
						data: {
							id: treeNode_id,
							isValid: 1,
							u_Name: u_Name,
							u_Code: u_Code,
							u_Parent: u_Parent,
							zdId: localStorage.getItem("station_id")
						},
						success: function(res) {
							treeNode_id = "undefined";
							layer.closeAll('loading');
							if (res.code == 0) {
								layer.msg(res.msg, {
									icon: 1
								});
								insTb.reload();
							} else {
								layer.msg(res.msg, {
									icon: 2
								});
							}
						}
					});
				});


				var tree = $.fn.zTree.init($('#treeAuth'), setting, list);

				var list1 = [{
					name: '名称',
					applier: '供应商',
					weight: 99,
					bl: 50
				}]
				var insTb = table.render({
					elem: '#tableYcl',
					data: list1,
					cellMinWidth: 100,
					height: 320,
					cols: [
						[{
								field: 'name',
								align: 'center',
								title: '材料名称'
							},
							{
								field: 'applier',
								align: 'center',
								title: '供应商'
							},
							{
								field: 'weight',
								align: 'center',
								title: '扣除重量(吨)'
							},
							{
								field: 'bl',
								align: 'center',
								title: '扣除比例(%)'
							},
						]
					],
					request: {
						pageName: 'currentIndex', //页码的参数名称，默认：page
						limitName: 'pageSize' //每页数据量的参数名，默认：limit
					},
					where: {
						zdId: $('#zdId').val(),
						createTime: $('#create-time').text(),
						type: 1
					},
					response: {
						countName: 'totalCount', //数据总数的字段名称，默认：count
						dataName: 'list' //数据列表的字段名称，默认：data
					}
				});

				$('#openBtn').on('click', () => {
					tree.expandAll(true);
				})
				$('#closeBtn').on('click', () => {
					tree.expandAll(false);
				})
			});

			function getDelete() {
				$.ajax({
					url: url + '/yuancailiao/delete',
					type: 'post',
					async: false,
					dataType: 'json',
					data: {
						id: node_tree,
						table_name: 'Sys_Material_T',
						zdId: localStorage.getItem("station_id")
						
					},
					success: function(res) {
						if (res.code == 0) {
							window.location.reload();
						} else {
							layer.msg(res.msg, {
								icon: 2
							});
						}
					}
				});
			}

			function getload() {
				window.location.reload();
			}
		</script>

	</body>
</html>
