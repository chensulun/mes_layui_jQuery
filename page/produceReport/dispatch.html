<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>生产调度</title>
    <link rel="stylesheet" href="../../assets/libs/layui/css/layui.css"/>
    <link rel="stylesheet" href="../../assets/module/admin.css?v=314"/>
    <link rel="stylesheet" href="../../assets/css/common_likui.css?v=314"/>
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <style>
        .search-container {
            height: 144px;
            padding: 57px 300px 57px 20px;
            box-sizing: border-box;
            position: relative;
        }
        .search-container .layui-form-radio {
            margin: 0 30px 0 0 ;
        }
        .project-setting-table {
            padding: 0px 360px 0px 0px;
            box-sizing: border-box;
            min-height: 700px;
            position: relative;
        }
        .dispatch-left {
            width: 100%;
            background-color: #fff;
            box-sizing: border-box;
            padding: 20px 30px;
        }
        .dispath-item-container {
            height: 192px;
            background-color: rgba(251, 251, 251, 1);
            color: rgba(102, 102, 102, 1);
        }
        .dispath-item-header {
            height: 28px;
            line-height: 28px;
            background-color: rgba(233, 245, 242, 1);
            padding: 0 8px;
        }
        .dispath-title {
            color: rgba(56, 56, 56, 1);
            margin-right: 8px;
        }
        .dispatch-right {
            width: 345px;
            height: 100%;
            position: absolute;
            top: 0;
            right: 0;
        }
        .dispatch-right-top {
            background-color: #fff;
            font-size: 13px;
            padding: 20px 10px;
        }
        .dispatch-right-top-title {
            color: rgba(85, 101, 126, 1);
            line-height: 22px;
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 10px;
        }
        .dispatch-right-top .layui-form-item {
            margin-bottom: 0;
        }
        .dispatch-right-top .layui-form-label {
            width: 90px;
            padding: 4px;
            color: rgba(56, 56, 56, 1);
        }
        .dispatch-right-top .layui-input-block {
            padding: 4px;
            line-height: 20px;
            box-sizing: border-box;
            min-height: 20px;
            margin-left: 100px;
            color: rgba(102, 102, 102, 1);
        }
        .dispatch-right-bottom {
            background-color: #fff;
            margin-top: 15px;
            padding: 8px 10px;
        }
        .dispatch-right-bottom .layui-table-cell {
            padding: 0 2px;
        }
        .layui-table, .layui-table-view {
            margin: 0;
        }
        .task-status-container {
            width: 300px;
            height: 95px;
            position: absolute;
            right: 0px;
            top: 23px;
            border-left: 1px solid rgba(227, 227, 227, 1);
        }
        .task-status-item {
            height: 100%;
            padding-top: 6px;
            text-align: center;
            line-height: 20px;
        }
        .rank-btn.ml-5 {
            background-color: rgba(56, 146, 242, 1);
        }
        .rank-btn.ml-6 {
            background-color: #FE8B14;
        }
        .rank-btn {
            display: inline-block;
            width: 20px;
            height: 20px;
            line-height: 20px;
            font-size: 10px;
            text-align: center;
            border-radius: 50%;
            cursor: pointer;
            background-color: rgba(80, 115, 228, 1);
            color: #fff;
            font-weight: bolder;
            
        }
        .rank-btn:hover {
            background-color: rgba(153, 153, 153, 1);
            color: #fff;
        }
        .layui-table tbody tr:hover, .layui-table-click, .layui-table-hover, .layui-table-mend, .layui-table-patch, .layui-table-tool, .layui-table-total, .layui-table-total tr, .layui-table[lay-even] tr:nth-child(even) {
            background-color: rgba(249, 250, 255, 1);
        }
        .adjust-container .layui-form-label {
            width: 130px;
            box-sizing: border-box;
            padding-right: 0;
        }
        .adjust-container .layui-input-block {
            margin-left: 140px;
        }
        .adjust-tab-title {
            font-size:14px;
            font-family:PingFangSC-Medium,PingFang SC;
            font-weight:500;
            color:rgba(51,51,51,1);
            line-height:30px;
        }
        .dispatchsdiv {
            position: relative;
        }
        .right-modal-container {
            width: 100%;
            height: 192px;
            position: absolute;
            top: 0;
            left: 0;
            background-color: transparent;
        }
        .right-modal {
            width: 120px;
            border: 1px solid #ddd;
            background-color: #fff;
            position: absolute;
            left: 0px;
            top: 0px;
        }
        .right-modal li {
            height: 36px;
            line-height: 36px;
            padding-left: 10px;
        }
        .right-modal li:hover {
            background-color: #f5f5f5;
        }
    </style>
</head>
<body>

<!-- 页面加载loading -->
<div class="page-loading">
    <div class="ball-loader">
        <span></span><span></span><span></span><span></span>
    </div>
</div>

<!-- 正文开始 -->
<div class="layui-fluid">
    <div class="layui-card" style="background-color: initial;">
        <div class="layui-card-body">
            <div class="layui-form toolbar">
                <div class="layui-form-item">
                    <div class="search-container bg-white">
                        <div class="layui-inline">
                            <!-- <label class="layui-form-label w-auto">日&emsp;期：</label> -->
                            <div class="layui-input-inline" style="width: 140px;">
                                <input type="text" name="taskStartTime" class="layui-input" id="test-laydate-start" placeholder="开始日期" lay-key="1">
                            </div>
                            <div class="layui-form-mid"> - </div>
                            <div class="layui-input-inline" style="width: 140px;">
                                <input type="text" name="taskEndTime" class="layui-input" id="test-laydate-end" placeholder="结束日期" lay-key="2">
                            </div>

                        </div>
                        <div class="layui-inline" style="margin-right: 20px;width: 200px;">
                            <input name="keywords" class="layui-input" type="text" id="keywords" placeholder="请输入关键字"/>
                        </div>
                        <div class="layui-inline" style="margin-right: 15px;">
                            <button id="btnSearch"  lay-filter="formDispatchSearch"  lay-submit  class="layui-btn layui-btn-green3">查询</button>
                        </div>
                        <div class="layui-inline" style="margin-right: 15px;">
                            <button id="btnAddProject" class="layui-btn layui-btn-blue3">待供任务单</button>
                        </div> 
						<div class="layui-inline" style="margin-right: 15px;">
                            <button id="btnAddSupplyProject" class="layui-btn layui-btn-blue3">供毕任务单</button>
                        </div>
                       <div class="task-status-container">
                               <div class="layui-row" style="height: 50%;">
                                   <div class="layui-col-md6 task-status-item">
                                       <div class="text-red"  id="task_count" style="font-size: 20px;">0</div>
                                       <div class="text-gray" style="font-size: 12px;"><i class="layui-icon" style="margin-right: 6px;font-size: 18px;">&#xe60a;</i>任务单数</div>
                                   </div>
                                   <div class="layui-col-md6 task-status-item">
                                       <div class="text-gray1"  id="plan_count"  style="font-size: 20px;">0</div>
                                       <div class="text-gray" style="font-size: 12px;"><i class="layui-icon" style="margin-right: 6px;">&#xe63c;</i>总计划量</div>
                                   </div>
                               </div>
                               <div class="layui-row" style="height: 50%;">
                                   <div class="layui-col-md6 task-status-item">
                                       <div class="text-gray1"  id="ship_count"  style="font-size: 20px;">0</div>
                                       <div class="text-gray" style="font-size: 12px;"><i class="layui-icon" style="margin-right: 6px;">&#xe857;</i>总发货量</div>
                                   </div>
                                   <div class="layui-col-md6 task-status-item">
                                       <div class="text-gray1"  id="start_count"   style="font-size: 20px;">0</div>
                                       <div class="text-gray" style="font-size: 12px;"><i class="layui-icon" style="margin-right: 6px;">&#xe609;</i>总发车次数</div>
                                   </div>
                               </div>
                           </div>
                       </div>
                </div>
            </div>
            
            <div class="project-setting-table mt-20">
                <div class="dispatch-left">
                    <div class="layui-row"  id="dispatch">
                    </div>
                </div>
                <div class="dispatch-right">
                    <div class="dispatch-right-top">
                        <div class="dispatch-right-top-title">任务单明细信息</div>
                        <div class="layui-form-item">
                            <label class="layui-form-label">项目编号:</label>
                            <div class="layui-input-block"  id="project_no">
                           
                            </div>
                        </div>
                        <div class="layui-form-item">
                            <label class="layui-form-label">工程名称:</label>
                            <div class="layui-input-block"  id="engineer_name">
                               
                            </div>
                        </div>
                        <div class="layui-form-item">
                            <label class="layui-form-label">施工单位:</label>
                            <div class="layui-input-block"  id="sgdw">
                                
                            </div>
                        </div>
                        <div class="layui-form-item">
                            <label class="layui-form-label">工地地址:</label>
                            <div class="layui-input-block"  id="factory_addr">
                               
                            </div>
                        </div>
                        <div class="layui-form-item">
                            <label class="layui-form-label">工地联系人:</label>
                            <div class="layui-input-block"  id="factory_link_name">
                                
                            </div>
                        </div>
                        <div class="layui-form-item">
                            <label class="layui-form-label">联系电话:</label>
                            <div class="layui-input-block" id="factory_link_phone">
                               
                            </div>
                        </div>
                        <div class="layui-form-item">
                            <label class="layui-form-label">计划开盘时间:</label>
                            <div class="layui-input-block" id="scheduled_open" >
                                
                            </div>
                        </div>
                        <div class="layui-form-item">
                            <label class="layui-form-label">实际开盘时间:</label>
                            <div class="layui-input-block" id="actual_open">
                                
                            </div>
                        </div>
                    </div>
                    <div class="dispatch-right-bottom">
                        <div class="layui-tab layui-tab-brief" lay-filter="docDemoTabBrief">
                          <ul class="layui-tab-title">
                            <li class="layui-this">车辆排队</li>
                            <li>发货明细</li>
                          </ul>
                          <div class="layui-tab-content">
                            <div class="layui-tab-item layui-show">
                                <table class="layui-table" id="tableCar" lay-filter="tableCar"></table>
                            </div>
                            <div class="layui-tab-item">
                                <table class="layui-table" id="tableCargo" lay-filter="tableCargo"></table></div>
                          </div>
                        </div>
                    </div>
                </div>
            </div>
            
        </div>
    </div>
</div>

<!-- 表格操作列 -->
<script type="text/html" id="tableBarRank">
    <a class="rank-btn" lay-event="up">↑</a>
    <a class="rank-btn ml-5" lay-event="down">↓</a>
    <a class="rank-btn ml-6" lay-event="dispatch"><i class="layui-icon layui-icon-form" style="font-size: 10px;"></i></a>
</script>

<!-- 弹窗-待供任务单 -->
<script type="text/html" id="taskListModal">
    <div  class="layui-form" style="padding: 20px 30px;">
        <div class="layui-form-item">
            <label class="layui-form-label w-auto">日期：</label>
            <div class="layui-input-inline" style="width: 140px;">
                <input type="text" name="taskStartTime1" class="layui-input" id="test-laydate-start1"
                 placeholder="开始日期" lay-key="3">
            </div>
            <div class="layui-form-mid"> - </div>
            <div class="layui-input-inline" style="width: 140px;margin-right: 20px;">
                <input type="text" name="taskEndTime1" class="layui-input" id="test-laydate-end1"
                 placeholder="结束日期" lay-key="4">
            </div>
            <div class="layui-input-inline">
                <input type="text" name="keywords1" id="keywords1" class="layui-input" placeholder="请输入关键词">
            </div>
            <div class="layui-inline" style="margin-right: 15px;padding-top: 4px;">
                <button id="btnSearch1" lay-filter="formDispatchSearch1"  lay-submit  class="layui-btn layui-btn-green3">查询</button>
            </div>
            <div class="layui-inline" style="padding-top: 4px;">
                <button id="btnSubmit"  lay-filter="formDispatchPending" lay-submit class="layui-btn layui-btn-yellow">转正供任务单</button>
            </div>
        </div>
        <table class="layui-table" id="tableTaskList" lay-filter="tableTaskList"></table>
       <!--  <div class="layui-form-item text-center">
            <button class="layui-btn layui-btn-primary" lay-filter="modelSubmitAddCustomer" lay-submit>保存</button>
            <button class="layui-btn" type="button" ew-event="closePageDialog">取消</button>
        </div> -->
    </div>
</script>


<!-- 弹窗-待供任务单 -->
<script type="text/html" id="taskSupplyListModal">
    <div  class="layui-form" style="padding: 20px 30px;">
        <div class="layui-form-item">
            <label class="layui-form-label w-auto">日期：</label>
            <div class="layui-input-inline" style="width: 140px;">
                <input type="text" name="taskStartSupplyTime1" class="layui-input" id="test-laydate-supply-start1"
                 placeholder="开始日期" lay-key="5">
            </div>
            <div class="layui-form-mid"> - </div>
            <div class="layui-input-inline" style="width: 140px;margin-right: 20px;">
                <input type="text" name="taskEndSupplyTime1" class="layui-input" id="test-laydate-supply-end1"
                 placeholder="结束日期" lay-key="6">
            </div>
            <div class="layui-input-inline">
                <input type="text" name="keywordssupply1" id="keywordssupply1" class="layui-input" placeholder="请输入关键词">
            </div>
            <div class="layui-inline" style="margin-right: 15px;padding-top: 4px;">
                <button id="btnSearSupplych1" lay-filter="formDispatchSupplySearch1"  lay-submit  class="layui-btn layui-btn-green3">查询</button>
            </div>
            <div class="layui-inline" style="padding-top: 4px;">
                <button id="btnSupplySubmit"  lay-filter="formDispatchSupplyPending" lay-submit class="layui-btn layui-btn-yellow">转正供任务单</button>
            </div>
        </div>
        <table class="layui-table" id="tableTaskSupplyList" lay-filter="tableTaskSupplyList"></table>
       <!--  <div class="layui-form-item text-center">
            <button class="layui-btn layui-btn-primary" lay-filter="modelSubmitAddCustomer" lay-submit>保存</button>
            <button class="layui-btn" type="button" ew-event="closePageDialog">取消</button>
        </div> -->
    </div>
</script>

<!-- 调整-弹窗 -->
<script type="text/html" id="adjustModal">
    <form id="modelAdjustorm" lay-filter="modelAdjustorm" class="layui-form model-form adjust-container">
        <div class="layui-form-item">
            <div class="layui-row">
                <div class="layui-col-md6 mb-20">
                    <label class="layui-form-label">级配编号</label>
                    <div class="layui-input-block">
                        <input name="jpbh" id="jpbh" readonly="readonly" type="text" class="layui-input"/>
                    </div>
                </div>
                <div class="layui-col-md6 mb-20">
                    <label class="layui-form-label">混合科类型</label>
                    <div class="layui-input-block">
                        <input name="hhklx" id="hhklx" readonly="readonly" type="text" class="layui-input"/>
                    </div>
                </div>
                <div class="layui-col-md6 mb-20">
                    <label class="layui-form-label">沥青标号</label>
                    <div class="layui-input-block">
                       <input name="lqbh" id="lqbh" readonly="readonly" type="text" class="layui-input"/>
                    </div>
                </div>
                <div class="layui-col-md6 mb-20">
                    <label class="layui-form-label">区间温度</label>
                    <div class="layui-input-block">
                          <input name="qjwd" id="qjwd" readonly="readonly" type="text" class="layui-input"/>
                    </div>
                </div>
                <div class="layui-col-md6 mb-20">
                    <label class="layui-form-label">班次</label>
                    <div class="layui-input-block">
                        <input name="bc" id="bc" readonly="readonly" type="text" class="layui-input"/>
                    </div>
                </div>
                <div class="layui-col-md6 mb-20">
                    <label class="layui-form-label">天气</label>
                    <div class="layui-input-block">
                       <input name="tq" id="tq" readonly="readonly" type="text" class="layui-input"/>
                    </div>
                </div>
                <div class="layui-col-md6 mb-20">
                    <label class="layui-form-label">石料加热温度(℃)</label>
                    <div class="layui-input-block">
                        <input name="sljrwd" id="sljrwd" readonly="readonly" type="text" class="layui-input"/>
                    </div>
                </div>
                <div class="layui-col-md6 mb-20">
                    <label class="layui-form-label">产品出厂温度(℃)</label>
                    <div class="layui-input-block">
                       <input name="cpccwd" id="cpccwd" readonly="readonly" type="text" class="layui-input"/>
                    </div>
                </div>
                <div class="layui-col-md6 mb-20">
                    <label class="layui-form-label">机号</label>
                    <div class="layui-input-block">
                         <input name="jh" id="jh" readonly="readonly" type="text" class="layui-input"/>
                    </div>
                </div>
                <div class="layui-col-md6 mb-20">
                    <label class="layui-form-label">沥青加热温度(℃)</label>
                    <div class="layui-input-block">
                        <input name="lqjrwd" id="lqjrwd" readonly="readonly" type="text" class="layui-input"/>
                    </div>
                </div>
                <div class="layui-col-md6 mb-20">
                    <label class="layui-form-label">日期</label>
                    <div class="layui-input-block">
                         <input name="rq" id="rq" readonly="readonly" type="text" class="layui-input"/>
                    </div>
                </div>
                <div class="layui-col-md6 mb-20">
                    <label class="layui-form-label">干拌时间(s)</label>
                    <div class="layui-input-block">
                         <input name="gbsj" id="gbsj" readonly="readonly" type="text" class="layui-input"/>
                    </div>
                </div>
                <div class="layui-col-md6 mb-20">
                    <label class="layui-form-label">混拌时间(s)</label>
                    <div class="layui-input-block">
                        <input name="sbsj" id="sbsj" readonly="readonly" type="text" class="layui-input"/>
                    </div>
                </div>
                <div class="layui-col-md12">
                    <label class="layui-form-label">备注</label>
                    <div class="layui-input-block">
                        <textarea name="bz" id="bz" readonly="readonly" class="layui-textarea"></textarea>
                    </div>
                </div>
                
            </div>
        </div>
        <div class="layui-form-item">
            <div class="layui-row">
                <div class="layui-col-md6" style="padding: 20px 10px 20px 30px">
                    <div class="adjust-tab-title">原材料配比</div>
                    <table class="layui-table" id="tableYcl" lay-filter="tableYcl"></table>
                </div>
                <div class="layui-col-md6" style="padding: 20px 0px 20px 10px">
                    <div class="adjust-tab-title">热料仓配比</div>
                    <table class="layui-table" id="tableRlc" lay-filter="tableRlc"></table>
                </div>
            </div>
        </div>
      <!--  <div class="layui-form-item text-center">
            <button class="layui-btn layui-btn-primary" type="button">保存</button>
            <button class="layui-btn layui-btn-green2" type="button">取消</button>
        </div> -->
    </form>
</script>
<!-- js部分 -->
<script type="text/javascript" src="../../assets/libs/layui/layui.js"></script>
<script type="text/javascript" src="../../assets/js/common.js?v=314"></script>
<script type="text/javascript" src="../../assets/libs/jquery/jquery-3.2.1.min.js"></script>
<script>
	 //url="http://localhost:8080/";
		var table;
		var form;
		//var station;
    layui.use(['layer', 'form', 'table', 'util', 'laydate', 'admin', 'element'], function () {
        var $ = layui.jquery;
        var layer = layui.layer;
        form = layui.form;
        table = layui.table;
        var util = layui.util;
        var laydate = layui.laydate;
        var admin = layui.admin;
        var element = layui.element;
		
		//station = localStorage.getItem("station_list");
		//查询
		form.on('submit(formDispatchSearch)', function (data) {
			getTaskDispatchList();
		});
      
        var insTb = table.render({
            elem: '#tableCar',
            // even: true,
            // skin: 'nob',
            url: url + '/dispatch/GetAllQueue',
            cols: [[
				{field: 'id', title: '过磅单Id',hide:true},
                {field: 'row', title: '排号',align: 'center',width:60},
                {field: 'busNumber', align: 'center', title: '车牌号'},
                {field: 'deadweight', align: 'center', title: '载重'},
                {align: 'center', toolbar: '#tableBarRank', title: '操作'}
            ]],
			
		    request: {
		        pageName: 'currentIndex', //页码的参数名称，默认：page
		        limitName: 'pageSize' //每页数据量的参数名，默认：limit
		    },
			where: {
			   idzhandian:localStorage.getItem("station_id")
			   
			},
            response: {
                countName: 'totalCount', //数据总数的字段名称，默认：count
                dataName: 'list' //数据列表的字段名称，默认：data
            }
        });
		
		getTaskDispatchList();
        
        //日期
        laydate.render({
            elem: '#test-laydate-start',
            trigger: 'click',
            format: 'yyyy-MM-dd',
            done: function (value, date, endDate) {
                var startDate = new Date(value).getTime();
                var endTime = new Date($('#test-laydate-end').val()).getTime();
                if (endTime < startDate) {
                    layer.msg('开始时间不能大于结束时间');
                    $('#test-laydate-start').val($('#test-laydate-end').val());
                }
            }

        });
        laydate.render({
            elem: '#test-laydate-end',
            trigger: 'click',
            format: 'yyyy-MM-dd',
            done: function (value, date, endDate) {
                var startDate = new Date($('#test-laydate-start').val()).getTime();
                var endTime = new Date(value).getTime();
                if (endTime < startDate) {
                    layer.msg('结束时间不能小于开始时间');
                    $('#test-laydate-end').val($('#test-laydate-start').val());
                }
            }
        });
		
		// //日期
		// laydate.render({
		//     elem: '#test-laydate-supply-start',
		//     trigger: 'click',
		//     format: 'yyyy-MM-dd',
		//     done: function (value, date, endDate) {
		//         var startDate = new Date(value).getTime();
		//         var endTime = new Date($('#test-laydate-supply-end').val()).getTime();
		//         if (endTime < startDate) {
		//             layer.msg('开始时间不能大于结束时间');
		//             $('#test-laydate-supply-start').val($('#test-laydate-supply-end').val());
		//         }
		//     }
		
		// });
		// laydate.render({
		//     elem: '#test-laydate-supply-end',
		//     trigger: 'click',
		//     format: 'yyyy-MM-dd',
		//     done: function (value, date, endDate) {
		//         var startDate = new Date($('#test-laydate-supply-start').val()).getTime();
		//         var endTime = new Date(value).getTime();
		//         if (endTime < startDate) {
		//             layer.msg('结束时间不能小于开始时间');
		//             $('#test-laydate-supply-end').val($('#test-laydate-supply-start').val());
		//         }
		//     }
		// });
        table.on('tool(tableCar)', function (obj) {
            var layEvent = obj.event;
            if(layEvent === 'up'){
                // 排队上升
				var data=obj.data;
				if(!data.toprow){
					layer.msg("不能再升", {icon: 1});
					return;
					
				}else{
					$.post(url+"/dispatch/ChangeQueue",{id:data.id,type:1,orderId:data.orderId,idzhandian:localStorage.getItem("station_id")},function(res){
						if(res.code==0){
							insTb.reload();
						}else{
							  layer.msg(res.msg, {icon:2});
						}
					})
				}
            } else if (layEvent === 'down') {
                // 排队下降
				var data=obj.data;
				if(!data.downrow){
					layer.msg("不能下降", {icon: 1});
					return;
					
				}else{
					$.post(url+"/dispatch/ChangeQueue",{id:data.id,type:2,orderId:data.orderId},function(res){
						if(res.code==0){
							insTb.reload();
						}else{
							  layer.msg(res.msg, {icon:2});
						}
					})
				}
            }
            else if (layEvent === 'dispatch') {
                // 装毕
                var data=obj.data;
				$.post(url+"/dispatch/CharFinish",{id:data.id,busNumber:data.busNumber,idzhandian:localStorage.getItem("station_id")},function(res){
					if(res.code==0){
						insTb.reload();
					}else{
						  layer.msg(res.msg, {icon:2});
					}
				})
            }
        });
        // 打开供毕任务弹窗
          $('#btnAddProject').on('click', (e) => {
              showModel();
          });
        //代转任务单搜索
        form.on('submit(formDispatchSearch1)', function (data) {
        	getPendingTaskList();
        });
        //转正
        form.on('submit(formDispatchPending)', function (data) {
        	debugger;
        	if(pendingTaskIds==""){
        		  layer.msg("请至少选择一条数据", {icon: 1});
        		  return;
        	}
        	pendingTaskIds=pendingTaskIds.substring(0,pendingTaskIds.length-1);
        	$.post(url+"/dispatch/updateTaskStatus",{"taskIds":pendingTaskIds,state:1},function(res){
        		if(res.code==0){
        			getTaskDispatchList();
        			getPendingTaskList();
        			pendingTaskIds="";
        		}else{
        			layer.msg(res.msg, {icon: 2});
        			return;
        		}
        	})
        	
        });		
    
		
		
		
        // 打开供毕任务弹窗
        $('#btnAddSupplyProject').on('click', (e) => {
            showSupplyModel();
        });
		//代转任务单搜索
		form.on('submit(formDispatchSupplySearch1)', function (data) {
			getPendingTaskSupplyList();
		});
		//转正
		form.on('submit(formDispatchSupplyPending)', function (data) {
			debugger;
			if(pendingTaskSupplyIds==""){
				  layer.msg("请至少选择一条数据", {icon: 1});
				  return;
			}
			pendingTaskSupplyIds=pendingTaskSupplyIds.substring(0,pendingTaskSupplyIds.length-1);
			$.post(url+"/dispatch/updateTaskStatus",{"taskIds":pendingTaskSupplyIds,state:1},function(res){
				if(res.code==0){
					getTaskDispatchList();
					getPendingTaskSupplyList();
					pendingTaskSupplyIds="";
				}else{
					layer.msg(res.msg, {icon: 2});
					return;
				}
			})
			
		});
        function showModel() {
            admin.open({
                type: 1,
                title: '待供任务单列表',
                area: '1180px',
                content: $('#taskListModal').html(),
                success: function (layero, dIndex) {
					getPendingTaskList();
					//日期
					laydate.render({
					    elem: '#test-laydate-start1',
					    trigger: 'click',
					    format: 'yyyy-MM-dd',
					    done: function (value, date, endDate) {
					        var startDate = new Date(value).getTime();
					        var endTime = new Date($('#test-laydate-end1').val()).getTime();
					        if (endTime < startDate) {
					            layer.msg('开始时间不能大于结束时间');
					            $('#test-laydate-start1').val($('#test-laydate-end1').val());
					        }
					    }
					
					});
					laydate.render({
					    elem: '#test-laydate-end1',
					    trigger: 'click',
					    format: 'yyyy-MM-dd',
					    done: function (value, date, endDate) {
					        var startDate = new Date($('#test-laydate-start1').val()).getTime();
					        var endTime = new Date(value).getTime();
					        if (endTime < startDate) {
					            layer.msg('结束时间不能小于开始时间');
					            $('#test-laydate-end1').val($('#test-laydate-start1').val());
					        }
					    }
					});
                }
            });
        }
		
		function showSupplyModel() {
            admin.open({
                type: 1,
                title: '供毕任务单列表',
                area: '1180px',
                content: $('#taskSupplyListModal').html(),
                success: function (layero, dIndex) {
					getPendingTaskSupplyList();
					//日期
					laydate.render({
					    elem: '#test-laydate-supply-start1',
					    trigger: 'click',
					    format: 'yyyy-MM-dd',
					    done: function (value, date, endDate) {
					        var startDate = new Date(value).getTime();
					        var endTime = new Date($('#test-laydate-supply-end1').val()).getTime();
					        if (endTime < startDate) {
					            layer.msg('开始时间不能大于结束时间');
					            $('#test-laydate-supply-start1').val($('#test-laydate-supply-end1').val());
					        }
					    }
					
					});
					laydate.render({
					    elem: '#test-laydate-supply-end1',
					    trigger: 'click',
					    format: 'yyyy-MM-dd',
					    done: function (value, date, endDate) {
					        var startDate = new Date($('#test-laydate-supply-start1').val()).getTime();
					        var endTime = new Date(value).getTime();
					        if (endTime < startDate) {
					            layer.msg('结束时间不能小于开始时间');
					            $('#test-laydate-supply-end1').val($('#test-laydate-supply-start1').val());
					        }
					    }
					});
                }
            });
        }
	});
	var pendingTaskIds="";
	function showJiPeiModel(task_id) {
	    layui.admin.open({
	        type: 1,
	        area: '910px',
	        title: '生产级配调查看',
	        content: $('#adjustModal').html(),
	        success: function (layero, dIndex) {
				$.post(url+"/dispatch/getJipeiModel",{task_id:task_id},function(res){
					   if(res.code==0){
						   form.val('modelAdjustorm', res.data);
						  initYclTab(res.data.llcpb);
						  initRlcTab(res.data.rlcpb);
					   }
						
				})
	         
	        }
	    });
	}
	function getPendingTaskList(){
		var insTb = table.render({
		    elem: '#tableTaskList',
			page: true,
		    url: url + '/dispatch/getPendingTaskList',
		    //data: list3,
		    cols: [[
				{field: 'task_id', title: 'task_id',hide:true},
		        {type: 'checkbox', align: 'center'},
		        {field: 'task_no', align: 'center', title: '任务单编号'},
		        {field: 'engineer_name', align: 'center', title: '工程名称'},
		        {field: 'site_name', align: 'center', title: '施工部位'},
		        {field: 'concrete_name', align: 'center', title: '砼类型'},
		        {field: 'zqdl', align: 'center', title: '签订量'},
		        {field: 'plan_amount', align: 'center', title: '计划量'},
		        {field: 'transport_way', align: 'center', title: '运输方式'},
		        {field: 'temperature', align: 'center', title: '出厂温度'},
		        {field: 'site_supply', align: 'center', title: '工地需求供应时间'},
		    ]],
		    request: {
		        pageName: 'currentIndex', //页码的参数名称，默认：page
		        limitName: 'pageSize' //每页数据量的参数名，默认：limit
		    },
		    where: {
		       start_time:$("#test-laydate-start1").val(),
		       end_time:$("#test-laydate-end1").val(),
		       keywords: $("#keywords1").val(),
			   task_status:2,
			   idzhandian:localStorage.getItem("station_id")
		    },
		    response: {
		        countName: 'totalCount', //数据总数的字段名称，默认：count
		        dataName: 'list' //数据列表的字段名称，默认：data
		    }
		});
		table.on('checkbox(tableTaskList)', function(obj){
			debugger;
		   console.log(obj.checked); //当前是否选中状态
		   if(obj.type=="all"){
			   if(obj.checked){
				   var  alldata=table.checkStatus('tableTaskList').data;
				   for(var i=0;i<alldata.length;i++){
					     pendingTaskIds+=alldata[i].task_id+",";
				   }
			   }else{
				   pendingTaskIds="";
			   }
			  
		   }
		   else{
			   if(obj.checked){
			   			   pendingTaskIds+=obj.data.task_id+",";
			   }else{
			   			  pendingTaskIds=pendingTaskIds.replace(obj.data.task_id+",",""); 
			   }
		   }
		  
		   // console.log(obj.data); //选中行的相关数据
		   // console.log(obj.type); //如果触发的是全选，则为：all，如果触发的是单选，则为：one
		   // console.log(table.checkStatus('table-organization').data); // 获取表格中选中行的数据
		  });
		
	}
	var pendingTaskSupplyIds="";
	//供毕任务单列表
	function getPendingTaskSupplyList(){
		var insTb = table.render({
		    elem: '#tableTaskSupplyList',
			page: true,
		    url: url + '/dispatch/getPendingTaskList',
		    //data: list3,
		    cols: [[
				{field: 'task_id', title: 'task_id',hide:true},
		        {type: 'checkbox', align: 'center'},
		        {field: 'task_no', align: 'center', title: '任务单编号'},
		        {field: 'engineer_name', align: 'center', title: '工程名称'},
		        {field: 'site_name', align: 'center', title: '施工部位'},
		        {field: 'concrete_name', align: 'center', title: '砼类型'},
		        {field: 'zqdl', align: 'center', title: '签订量'},
		        {field: 'plan_amount', align: 'center', title: '计划量'},
		        {field: 'transport_way', align: 'center', title: '运输方式'},
		        {field: 'temperature', align: 'center', title: '出厂温度'},
		        {field: 'site_supply', align: 'center', title: '工地需求供应时间'},
		    ]],
		    request: {
		        pageName: 'currentIndex', //页码的参数名称，默认：page
		        limitName: 'pageSize' ,//每页数据量的参数名，默认：limit
				
		    },
		    where: {
		       start_time:$("#test-laydate-supply-start1").val(),
		       end_time:$("#test-laydate-supply-end1").val(),
		       keywords: $("#keywordssupply1").val(),
			   task_status:3,
			   idzhandian:localStorage.getItem("station_id")
			   
		    },
		    response: {
		        countName: 'totalCount', //数据总数的字段名称，默认：count
		        dataName: 'list' //数据列表的字段名称，默认：data
		    }
		});
		table.on('checkbox(tableTaskSupplyList)', function(obj){
			debugger;
		   console.log(obj.checked); //当前是否选中状态
		   if(obj.type=="all"){
			   if(obj.checked){
				   var  alldata=table.checkStatus('tableTaskSupplyList').data;
				   for(var i=0;i<alldata.length;i++){
					     pendingTaskSupplyIds+=alldata[i].task_id+",";
				   }
			   }else{
				   pendingTaskSupplyIds="";
			   }
			  
		   }
		   else{
			   if(obj.checked){
			   			   pendingTaskSupplyIds+=obj.data.task_id+",";
			   }else{
			   			  pendingTaskSupplyIds=pendingTaskSupplyIds.replace(obj.data.task_id+",",""); 
			   }
		   }
		  
		   // console.log(obj.data); //选中行的相关数据
		   // console.log(obj.type); //如果触发的是全选，则为：all，如果触发的是单选，则为：one
		   // console.log(table.checkStatus('table-organization').data); // 获取表格中选中行的数据
		  });
		
	}
	function getTaskDispatchList(){
			$.post(url+"/dispatch/getTaskDispatchList",{"start_time":$("#test-laydate-start").val(),"end_time":
			$("#test-laydate-end").val(),"keywords":$("#keywords").val(),"idzhandian":localStorage.getItem("station_id")},function(res){
				if(res.code==0){
					var html="";
					$("#project_no").text("");
					$("#engineer_name").text("");
					$("#sgdw").text("");
					$("#factory_addr").text("");
					$("#factory_link_name").text("");
					$("#factory_link_phone").text("");
					$("#scheduled_open").text("");
					$("#actual_open").text("");
					$("#dispatch").html(html);
					getDeliveryDetails([]);
					if(res.data!=null){
						if(res.data.dispatchList!=null && res.data.dispatchList.length>0){
							var dispatchList=res.data.dispatchList;
							
							$.each(dispatchList,function(i,item){
								var row=i+1;
								if(row<=9){
									row="0"+row;
								}
								var temperatureitem="";
								if(item.temperature!=undefined){
									temperatureitem=item.temperature;
								}
								var site_name="";
								if(item.site_name!=undefined){
									site_name=item.site_name;
								}
								var transport_way="";
								if(item.transport_way!=undefined){
									transport_way=item.transport_way;
								}
								var deliver_amount=item.deliver_amount;
								if(deliver_amount>0){
								deliver_amount=(deliver_amount/1000).toFixed(3);
								}
								html+='<div class="dispatchsdiv layui-col-md6" task_id="'+item.task_id+'" dq-item="'+ JSON.stringify(item).replace(/"/g, '&quot;') +'" style="padding: 10px;" ondblclick="showJiPeiModel(\''+ item.task_id+'\')">';
	                            html+='<div class="dispath-item-container">';
	                            html+='<div class="dispath-item-header clear">';
								if(projectName == "cangzhou"){
									  html+='<div class="pull-left" style="color: rgba(26, 185, 155, 1);">'+item.p_code+'</div>';
								}else{
									 html+='<div class="pull-left" style="color: rgba(26, 185, 155, 1);">'+item.project_no+'</div>';
								}
	                          
	                            html+='<div class="pull-right">【序号: '+row+'】</div>';
	                            html+='</div>';
	                            html+='<div style="margin-top: 6px;padding: 0 6px;"><span class="dispath-title">工程名称:</span>'+item.engineer_name+'</div>';
	                            html+='<div style="margin-top: 6px;padding: 0 6px;"><span class="dispath-title">施工部位:</span>'+site_name+'</div>';
	                            html+='<div style="margin-top: 6px;padding: 0 6px;color: rgba(255, 0, 0, 1);"><span class="dispath-title">砼类型:</span>'+item.concrete_name+'</div>';
	                            html+='<div style="margin-top: 6px;padding: 0 6px;" class="layui-row">';
	                            html+='<div class="layui-col-sm6 text-orange"><span class="dispath-title">运输方式:</span>'+transport_way+'</div>';
	                            html+='<div class="layui-col-sm6 text-green"><span class="dispath-title">出厂温度:</span>'+temperatureitem+'</div>';
	                            html+='</div>';
	                            html+='<div style="margin-top: 6px;padding: 0 6px;" class="layui-row">';
	                            html+='<div class="layui-col-sm6 text-blue"><span class="dispath-title">已发量:</span>'+deliver_amount+'</div>';
	                            html+='<div class="layui-col-sm6 text-red"><span class="dispath-title">计划量:</span>'+item.plan_amount+'</div>';
	                            html+='</div>';
	                            html+='</div>';
								html+='</div>';
								if(i==0){
									getDispatchDetail1(item);
								}
							})
							$("#dispatch").html(html);
							//$(".dispatchsdiv").eq(0).click();
							
							
							 $(".dispatchsdiv").unbind("mousedown").bind("mousedown", function (event) {
                                $('.dispatchsdiv').bind("contextmenu",function(e){
                                      return false;
                                });
					            if (event.which == 3) {
									var itemmodel=$(this).attr("dq-item");
									var task_id=$(this).attr("task_id");
                                    $(".right-modal-container").remove();
                                    var html = '<div class="right-modal-container"><ul class="right-modal"><li onclick="getDispatchDetail('+JSON.stringify(itemmodel).replace(/"/g, '&quot;')+')">查看</li><li onclick="gongbi('+task_id+')">供毕</li><li  onclick="daigong('+task_id+')">待供</li></ul></div>';
                                    $(this).append(html);
                                    $('.right-modal').css({'top': event.offsetY + 'px', 'left': event.offsetX + 'px'});
                                    $('.right-modal-container').on('click', () => {
                                        $('.right-modal-container').remove();
                                    }).on('mousedown', (e) => {
                                        if (e.which === 3) {
                                            console.log('youji')
                                            $('.right-modal-container').remove();
                                            e.stopPropagation();
                                        }
                                    });
					            }else if(event.which == 1){
						        } 
							 
							});
							
							
						}
						if(res.data.dispatchCount!=null){
						var dispatchCount=res.data.dispatchCount;
						var ship_count=dispatchCount.ship_count;
								if(ship_count>0){
								ship_count=(ship_count/1000).toFixed(3);
								}
							
							$("#task_count").text(dispatchCount.task_count);
							$("#plan_count").text(dispatchCount.plan_count);
							$("#ship_count").text(ship_count);
							$("#start_count").text(dispatchCount.start_count);
						}
					}
				}else{
					
				}
				
				
			})
		}
		
		//供毕
		function gongbi(taskId){
			layer.confirm('确定要将此任务单转为供毕吗？', {
			    skin: 'layui-layer-admin',
			    shade: .1
			}, function (i) {
			    layer.close(i);
			    layer.load(2);
			    $.post(url + '/dispatch/updateTaskStatus', {
			        taskIds: taskId,
					state:3
			    }, function (res) {
			        layer.closeAll('loading');
			        if (res.code == 0) {
			            layer.msg(res.msg, {icon: 1});
			            getTaskDispatchList();
			            $('#btnAddSupplyProject').click();
			        } else {
			            layer.msg(res.msg, {icon: 2});
			        }
			    }, 'json');
			});
		}
		//待供
		function daigong(taskId){
			layer.confirm('确定要将此任务单转为待供吗？', {
			    skin: 'layui-layer-admin',
			    shade: .1
			}, function (i) {
			    layer.close(i);
			    layer.load(2);
			    $.post(url + '/dispatch/updateTaskStatus', {
			        taskIds: taskId,
					state:2
			    }, function (res) {
			        layer.closeAll('loading');
			        if (res.code == 0) {
			            layer.msg(res.msg, {icon: 1});
			            getTaskDispatchList();
						$('#btnAddProject').click();
			        } else {
			            layer.msg(res.msg, {icon: 2});
			        }
			    }, 'json');
			});
		}
		
		
		function getDispatchDetail(dispatch1){
			// 显示调整弹窗
			// showJiPeiModel(dispatch.task_no);
			var dispatch=JSON.parse(dispatch1);
			if(projectName == "cangzhou"){
				$("#project_no").text(dispatch.p_code);
			}else{
				$("#project_no").text(dispatch.project_no);
			}
			
			$("#engineer_name").text(dispatch.engineer_name);
			$("#sgdw").text(dispatch.sgdw);
			$("#factory_addr").text(dispatch.factory_addr);
			$("#factory_link_name").text(dispatch.factory_link_name);
			$("#factory_link_phone").text(dispatch.factory_link_phone);
			$("#scheduled_open").text(dispatch.scheduled_open);
			$("#actual_open").text(dispatch.actual_open);
			getDeliveryDetails([]);
			getDeliveryDetails(dispatch.deliveryDetailsList);
		}
		
		
		
		function getDispatchDetail1(dispatch){
			// 显示调整弹窗
			// showJiPeiModel(dispatch.task_no);
			getDeliveryDetails([]);
			//$("#project_no").text(dispatch.project_no);
			if(projectName == "cangzhou"){
				$("#project_no").text(dispatch.p_code);
			}else{
				$("#project_no").text(dispatch.project_no);
			}
			$("#engineer_name").text(dispatch.engineer_name);
			$("#sgdw").text(dispatch.sgdw);
			$("#factory_addr").text(dispatch.factory_addr);
			$("#factory_link_name").text(dispatch.factory_link_name);
			$("#factory_link_phone").text(dispatch.factory_link_phone);
			$("#scheduled_open").text(dispatch.scheduled_open);
			$("#actual_open").text(dispatch.actual_open);
			getDeliveryDetails(dispatch.deliveryDetailsList);
		}
		function initYclTab(yclList) {
            var insYclTb = table.render({
                elem: '#tableYcl',
                data: yclList,
                cellMinWidth: 40,
                cols: [[
                    {field: 'llcgg', align: 'center', title: '冷料仓'},
                    {field: 'yclcs', align: 'center', title: '原材料厂商'},
                    {field: 'yclgg', align: 'center', title: '原材料规格'},
                    {field: 'zl', align: 'center', title: '重量'},
                    {field: 'bz', align: 'center', title: '备注'},
                ]],
                response: {
                    countName: 'totalCount', //数据总数的字段名称，默认：count
                    dataName: 'list' //数据列表的字段名称，默认：data
                }
            });
        }
        function initRlcTab(yclList) {
            var insYclTb = table.render({
                elem: '#tableRlc',
                data: yclList,
				limit:20,
                cellMinWidth: 40,
                cols: [[
                    {field: 'rlc', align: 'center', title: '热料仓规格'},
                    {field: 'zl', align: 'center', title: '重量'},
                    {field: 'bz', align: 'center', title: '备注'},
                ]],
                response: {
                    countName: 'totalCount', //数据总数的字段名称，默认：count
                    dataName: 'list' //数据列表的字段名称，默认：data
                }
            });
        }
		function getDeliveryDetails(list){
			//发货明细
			var insTb1 = table.render({
			    elem: '#tableCargo',
			    even: true,
			    skin: 'nob',
			    // url: url + '/role/getRoleList',
			    data: list,
			    cellMinWidth: 40,
			    cols: [[
			        {field: 'row', title: '排号', align: 'center'},
			        {field: 'bus_number', align: 'center', title: '车牌号', width: 80},
			        {field: 'concrete_name', align: 'center', title: '砼类型', width:50},
			        {align: 'center', title: '发货量', width: 50,templet:function(d){
						if(d.print_net_weight>0){
							return (d.print_net_weight/1000).toFixed(3);
						}
					
					}},
			        {field: 'final_date', align: 'center', title: '出厂时间', width: 80},
			    ]],
			    request: {
			        pageName: 'currentIndex', //页码的参数名称，默认：page
			        limitName: 'pageSize' //每页数据量的参数名，默认：limit
			    },
			    where: {
			       zdId:$('#zdId').val(),
			       createTime:$('#create-time').text(),
			       type: 1
			    },
			    response: {
			        countName: 'totalCount', //数据总数的字段名称，默认：count
			        dataName: 'list' //数据列表的字段名称，默认：data
			    }
			});
		}
        
</script>

</body>
</html>